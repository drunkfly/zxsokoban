# file opened: game.asm
  1   0000
  2   0000              					device 		zxspectrum48
  3   0000
  4   0000              stack_top:
  5   0000
  6   0000              					include		"irq.asm"
# file opened: irq.asm
  1+  0000
  2+  0000              					org			8000h
  3+  8000
  4+  8000              INTERRUPT = 81h
  5+  8000
  6+  8000              irq_vectors:		dup			257
  7+  8000 81          >					db			INTERRUPT
  7+  8001 81          >					db			INTERRUPT
  7+  8002 81          >					db			INTERRUPT
  7+  8003 81          >					db			INTERRUPT
  7+  8004 81          >					db			INTERRUPT
  7+  8005 81          >					db			INTERRUPT
  7+  8006 81          >					db			INTERRUPT
  7+  8007 81          >					db			INTERRUPT
  7+  8008 81          >					db			INTERRUPT
  7+  8009 81          >					db			INTERRUPT
  7+  800A 81          >					db			INTERRUPT
  7+  800B 81          >					db			INTERRUPT
  7+  800C 81          >					db			INTERRUPT
  7+  800D 81          >					db			INTERRUPT
  7+  800E 81          >					db			INTERRUPT
  7+  800F 81          >					db			INTERRUPT
  7+  8010 81          >					db			INTERRUPT
  7+  8011 81          >					db			INTERRUPT
  7+  8012 81          >					db			INTERRUPT
  7+  8013 81          >					db			INTERRUPT
  7+  8014 81          >					db			INTERRUPT
  7+  8015 81          >					db			INTERRUPT
  7+  8016 81          >					db			INTERRUPT
  7+  8017 81          >					db			INTERRUPT
  7+  8018 81          >					db			INTERRUPT
  7+  8019 81          >					db			INTERRUPT
  7+  801A 81          >					db			INTERRUPT
  7+  801B 81          >					db			INTERRUPT
  7+  801C 81          >					db			INTERRUPT
  7+  801D 81          >					db			INTERRUPT
  7+  801E 81          >					db			INTERRUPT
  7+  801F 81          >					db			INTERRUPT
  7+  8020 81          >					db			INTERRUPT
  7+  8021 81          >					db			INTERRUPT
  7+  8022 81          >					db			INTERRUPT
  7+  8023 81          >					db			INTERRUPT
  7+  8024 81          >					db			INTERRUPT
  7+  8025 81          >					db			INTERRUPT
  7+  8026 81          >					db			INTERRUPT
  7+  8027 81          >					db			INTERRUPT
  7+  8028 81          >					db			INTERRUPT
  7+  8029 81          >					db			INTERRUPT
  7+  802A 81          >					db			INTERRUPT
  7+  802B 81          >					db			INTERRUPT
  7+  802C 81          >					db			INTERRUPT
  7+  802D 81          >					db			INTERRUPT
  7+  802E 81          >					db			INTERRUPT
  7+  802F 81          >					db			INTERRUPT
  7+  8030 81          >					db			INTERRUPT
  7+  8031 81          >					db			INTERRUPT
  7+  8032 81          >					db			INTERRUPT
  7+  8033 81          >					db			INTERRUPT
  7+  8034 81          >					db			INTERRUPT
  7+  8035 81          >					db			INTERRUPT
  7+  8036 81          >					db			INTERRUPT
  7+  8037 81          >					db			INTERRUPT
  7+  8038 81          >					db			INTERRUPT
  7+  8039 81          >					db			INTERRUPT
  7+  803A 81          >					db			INTERRUPT
  7+  803B 81          >					db			INTERRUPT
  7+  803C 81          >					db			INTERRUPT
  7+  803D 81          >					db			INTERRUPT
  7+  803E 81          >					db			INTERRUPT
  7+  803F 81          >					db			INTERRUPT
  7+  8040 81          >					db			INTERRUPT
  7+  8041 81          >					db			INTERRUPT
  7+  8042 81          >					db			INTERRUPT
  7+  8043 81          >					db			INTERRUPT
  7+  8044 81          >					db			INTERRUPT
  7+  8045 81          >					db			INTERRUPT
  7+  8046 81          >					db			INTERRUPT
  7+  8047 81          >					db			INTERRUPT
  7+  8048 81          >					db			INTERRUPT
  7+  8049 81          >					db			INTERRUPT
  7+  804A 81          >					db			INTERRUPT
  7+  804B 81          >					db			INTERRUPT
  7+  804C 81          >					db			INTERRUPT
  7+  804D 81          >					db			INTERRUPT
  7+  804E 81          >					db			INTERRUPT
  7+  804F 81          >					db			INTERRUPT
  7+  8050 81          >					db			INTERRUPT
  7+  8051 81          >					db			INTERRUPT
  7+  8052 81          >					db			INTERRUPT
  7+  8053 81          >					db			INTERRUPT
  7+  8054 81          >					db			INTERRUPT
  7+  8055 81          >					db			INTERRUPT
  7+  8056 81          >					db			INTERRUPT
  7+  8057 81          >					db			INTERRUPT
  7+  8058 81          >					db			INTERRUPT
  7+  8059 81          >					db			INTERRUPT
  7+  805A 81          >					db			INTERRUPT
  7+  805B 81          >					db			INTERRUPT
  7+  805C 81          >					db			INTERRUPT
  7+  805D 81          >					db			INTERRUPT
  7+  805E 81          >					db			INTERRUPT
  7+  805F 81          >					db			INTERRUPT
  7+  8060 81          >					db			INTERRUPT
  7+  8061 81          >					db			INTERRUPT
  7+  8062 81          >					db			INTERRUPT
  7+  8063 81          >					db			INTERRUPT
  7+  8064 81          >					db			INTERRUPT
  7+  8065 81          >					db			INTERRUPT
  7+  8066 81          >					db			INTERRUPT
  7+  8067 81          >					db			INTERRUPT
  7+  8068 81          >					db			INTERRUPT
  7+  8069 81          >					db			INTERRUPT
  7+  806A 81          >					db			INTERRUPT
  7+  806B 81          >					db			INTERRUPT
  7+  806C 81          >					db			INTERRUPT
  7+  806D 81          >					db			INTERRUPT
  7+  806E 81          >					db			INTERRUPT
  7+  806F 81          >					db			INTERRUPT
  7+  8070 81          >					db			INTERRUPT
  7+  8071 81          >					db			INTERRUPT
  7+  8072 81          >					db			INTERRUPT
  7+  8073 81          >					db			INTERRUPT
  7+  8074 81          >					db			INTERRUPT
  7+  8075 81          >					db			INTERRUPT
  7+  8076 81          >					db			INTERRUPT
  7+  8077 81          >					db			INTERRUPT
  7+  8078 81          >					db			INTERRUPT
  7+  8079 81          >					db			INTERRUPT
  7+  807A 81          >					db			INTERRUPT
  7+  807B 81          >					db			INTERRUPT
  7+  807C 81          >					db			INTERRUPT
  7+  807D 81          >					db			INTERRUPT
  7+  807E 81          >					db			INTERRUPT
  7+  807F 81          >					db			INTERRUPT
  7+  8080 81          >					db			INTERRUPT
  7+  8081 81          >					db			INTERRUPT
  7+  8082 81          >					db			INTERRUPT
  7+  8083 81          >					db			INTERRUPT
  7+  8084 81          >					db			INTERRUPT
  7+  8085 81          >					db			INTERRUPT
  7+  8086 81          >					db			INTERRUPT
  7+  8087 81          >					db			INTERRUPT
  7+  8088 81          >					db			INTERRUPT
  7+  8089 81          >					db			INTERRUPT
  7+  808A 81          >					db			INTERRUPT
  7+  808B 81          >					db			INTERRUPT
  7+  808C 81          >					db			INTERRUPT
  7+  808D 81          >					db			INTERRUPT
  7+  808E 81          >					db			INTERRUPT
  7+  808F 81          >					db			INTERRUPT
  7+  8090 81          >					db			INTERRUPT
  7+  8091 81          >					db			INTERRUPT
  7+  8092 81          >					db			INTERRUPT
  7+  8093 81          >					db			INTERRUPT
  7+  8094 81          >					db			INTERRUPT
  7+  8095 81          >					db			INTERRUPT
  7+  8096 81          >					db			INTERRUPT
  7+  8097 81          >					db			INTERRUPT
  7+  8098 81          >					db			INTERRUPT
  7+  8099 81          >					db			INTERRUPT
  7+  809A 81          >					db			INTERRUPT
  7+  809B 81          >					db			INTERRUPT
  7+  809C 81          >					db			INTERRUPT
  7+  809D 81          >					db			INTERRUPT
  7+  809E 81          >					db			INTERRUPT
  7+  809F 81          >					db			INTERRUPT
  7+  80A0 81          >					db			INTERRUPT
  7+  80A1 81          >					db			INTERRUPT
  7+  80A2 81          >					db			INTERRUPT
  7+  80A3 81          >					db			INTERRUPT
  7+  80A4 81          >					db			INTERRUPT
  7+  80A5 81          >					db			INTERRUPT
  7+  80A6 81          >					db			INTERRUPT
  7+  80A7 81          >					db			INTERRUPT
  7+  80A8 81          >					db			INTERRUPT
  7+  80A9 81          >					db			INTERRUPT
  7+  80AA 81          >					db			INTERRUPT
  7+  80AB 81          >					db			INTERRUPT
  7+  80AC 81          >					db			INTERRUPT
  7+  80AD 81          >					db			INTERRUPT
  7+  80AE 81          >					db			INTERRUPT
  7+  80AF 81          >					db			INTERRUPT
  7+  80B0 81          >					db			INTERRUPT
  7+  80B1 81          >					db			INTERRUPT
  7+  80B2 81          >					db			INTERRUPT
  7+  80B3 81          >					db			INTERRUPT
  7+  80B4 81          >					db			INTERRUPT
  7+  80B5 81          >					db			INTERRUPT
  7+  80B6 81          >					db			INTERRUPT
  7+  80B7 81          >					db			INTERRUPT
  7+  80B8 81          >					db			INTERRUPT
  7+  80B9 81          >					db			INTERRUPT
  7+  80BA 81          >					db			INTERRUPT
  7+  80BB 81          >					db			INTERRUPT
  7+  80BC 81          >					db			INTERRUPT
  7+  80BD 81          >					db			INTERRUPT
  7+  80BE 81          >					db			INTERRUPT
  7+  80BF 81          >					db			INTERRUPT
  7+  80C0 81          >					db			INTERRUPT
  7+  80C1 81          >					db			INTERRUPT
  7+  80C2 81          >					db			INTERRUPT
  7+  80C3 81          >					db			INTERRUPT
  7+  80C4 81          >					db			INTERRUPT
  7+  80C5 81          >					db			INTERRUPT
  7+  80C6 81          >					db			INTERRUPT
  7+  80C7 81          >					db			INTERRUPT
  7+  80C8 81          >					db			INTERRUPT
  7+  80C9 81          >					db			INTERRUPT
  7+  80CA 81          >					db			INTERRUPT
  7+  80CB 81          >					db			INTERRUPT
  7+  80CC 81          >					db			INTERRUPT
  7+  80CD 81          >					db			INTERRUPT
  7+  80CE 81          >					db			INTERRUPT
  7+  80CF 81          >					db			INTERRUPT
  7+  80D0 81          >					db			INTERRUPT
  7+  80D1 81          >					db			INTERRUPT
  7+  80D2 81          >					db			INTERRUPT
  7+  80D3 81          >					db			INTERRUPT
  7+  80D4 81          >					db			INTERRUPT
  7+  80D5 81          >					db			INTERRUPT
  7+  80D6 81          >					db			INTERRUPT
  7+  80D7 81          >					db			INTERRUPT
  7+  80D8 81          >					db			INTERRUPT
  7+  80D9 81          >					db			INTERRUPT
  7+  80DA 81          >					db			INTERRUPT
  7+  80DB 81          >					db			INTERRUPT
  7+  80DC 81          >					db			INTERRUPT
  7+  80DD 81          >					db			INTERRUPT
  7+  80DE 81          >					db			INTERRUPT
  7+  80DF 81          >					db			INTERRUPT
  7+  80E0 81          >					db			INTERRUPT
  7+  80E1 81          >					db			INTERRUPT
  7+  80E2 81          >					db			INTERRUPT
  7+  80E3 81          >					db			INTERRUPT
  7+  80E4 81          >					db			INTERRUPT
  7+  80E5 81          >					db			INTERRUPT
  7+  80E6 81          >					db			INTERRUPT
  7+  80E7 81          >					db			INTERRUPT
  7+  80E8 81          >					db			INTERRUPT
  7+  80E9 81          >					db			INTERRUPT
  7+  80EA 81          >					db			INTERRUPT
  7+  80EB 81          >					db			INTERRUPT
  7+  80EC 81          >					db			INTERRUPT
  7+  80ED 81          >					db			INTERRUPT
  7+  80EE 81          >					db			INTERRUPT
  7+  80EF 81          >					db			INTERRUPT
  7+  80F0 81          >					db			INTERRUPT
  7+  80F1 81          >					db			INTERRUPT
  7+  80F2 81          >					db			INTERRUPT
  7+  80F3 81          >					db			INTERRUPT
  7+  80F4 81          >					db			INTERRUPT
  7+  80F5 81          >					db			INTERRUPT
  7+  80F6 81          >					db			INTERRUPT
  7+  80F7 81          >					db			INTERRUPT
  7+  80F8 81          >					db			INTERRUPT
  7+  80F9 81          >					db			INTERRUPT
  7+  80FA 81          >					db			INTERRUPT
  7+  80FB 81          >					db			INTERRUPT
  7+  80FC 81          >					db			INTERRUPT
  7+  80FD 81          >					db			INTERRUPT
  7+  80FE 81          >					db			INTERRUPT
  7+  80FF 81          >					db			INTERRUPT
  7+  8100 81          >					db			INTERRUPT
  8+  8101              					edup
  9+  8101
 10+  8101 00 00 00...  					ds			(INTERRUPT*256+INTERRUPT)-$
 11+  8181
 12+  8181              					org			(INTERRUPT*256+INTERRUPT)
 13+  8181
 14+  8181 F5           interrupt:			push		af
 15+  8182 C5           					push		bc
 16+  8183 D5           					push		de
 17+  8184 E5           					push		hl
 18+  8185 08           					ex			af, af'
 19+  8186 D9           					exx
 20+  8187 F5           					push		af
 21+  8188 C5           					push		bc
 22+  8189 D5           					push		de
 23+  818A E5           					push		hl
 24+  818B DD E5        					push		ix
 25+  818D FD E5        					push		iy
 26+  818F
 27+  818F 21 DE 81     					ld			hl, FramesPending
 28+  8192 34           					inc			(hl)
 29+  8193
 30+  8193              					; рисуем спрайты
 31+  8193
 32+  8193 DD 21 C9 86  					ld			ix, player1
 33+  8197 CD D2 86     					call		DrawPlayer
 34+  819A
 35+  819A              					; готово
 36+  819A
 37+  819A FD E1        					pop			iy
 38+  819C DD E1        					pop			ix
 39+  819E E1           					pop			hl
 40+  819F D1           					pop			de
 41+  81A0 C1           					pop			bc
 42+  81A1 F1           					pop			af
 43+  81A2 08           					ex			af, af'
 44+  81A3 D9           					exx
 45+  81A4 E1           					pop			hl
 46+  81A5 D1           					pop			de
 47+  81A6 C1           					pop			bc
 48+  81A7 F1           					pop			af
 49+  81A8 FB           					ei
 50+  81A9 C9           					ret
 51+  81AA
# file closed: irq.asm
  7   81AA
  8   81AA F3           start:				di
  9   81AB 31 00 00     					ld			sp, stack_top
 10   81AE 3E 80        					ld			a, 80h
 11   81B0 ED 47        					ld			i, a
 12   81B2 ED 5E        					im			2
 13   81B4 FB           					ei
 14   81B5
 15   81B5 3E 00        					ld			a, 00h
 16   81B7 CD DF 81     					call		ClearScreen
 17   81BA
 18   81BA CD 52 86     					call		InitLevel
 19   81BD CD 73 86     					call		DrawLevel
 20   81C0
 21   81C0 DD 21 C9 86  					ld			ix, player1
 22   81C4 CD CD 86     					call		InitPlayer
 23   81C7
 24   81C7 21 DE 81     .mainLoop:			ld			hl, FramesPending
 25   81CA AF           					xor			a
 26   81CB BE           					cp			(hl)
 27   81CC 28 0D        					jr			z, .halt
 28   81CE 35           					dec			(hl)
 29   81CF
 30   81CF CD 9D 83     					call		ReadInput
 31   81D2
 32   81D2 DD 21 C9 86  					ld			ix, player1
 33   81D6 CD 87 88     					call		HandlePlayer
 34   81D9
 35   81D9 18 EC        					jr			.mainLoop
 36   81DB
 37   81DB 76           .halt:				halt
 38   81DC 18 E9        					jr			.mainLoop
 39   81DE
 40   81DE 00           FramesPending:		db			0
 41   81DF
 42   81DF              					include		"draw.asm"
# file opened: draw.asm
  1+  81DF
  2+  81DF              				; Input:
  3+  81DF              				;   A = attribute
  4+  81DF
  5+  81DF              ClearScreen:	; очищаем пиксели
  6+  81DF 21 00 40     				ld		hl, 4000h
  7+  81E2 5D           				ld      e, l
  8+  81E3 54           				ld		d, h
  9+  81E4 36 00        				ld		(hl), 0
 10+  81E6 13           				inc		de
 11+  81E7 01 00 18     				ld		bc, 1800h
 12+  81EA ED B0        				ldir
 13+  81EC              				; очищаем атрибуты
 14+  81EC 77           				ld		(hl), a
 15+  81ED 01 FF 02     				ld		bc, 300h-1
 16+  81F0 ED B0        				ldir
 17+  81F2 C9           				ret
 18+  81F3
 19+  81F3                              ; Input:
 20+  81F3                              ;   C = X
 21+  81F3                              ;   B = Y (знакоместо)
 22+  81F3                              ;   IYH = старший байт адреса
 23+  81F3                              ; Output:
 24+  81F3                              ;   DE => screen addr
 25+  81F3
 26+  81F3              CalcScreenAddr: ; Преобразуем координату Y в пикселях в значение в знакоместах
 27+  81F3 78                           ld		a, b
 28+  81F4 17                           rla
 29+  81F5 17                           rla
 30+  81F6 17                           rla
 31+  81F7 E6 F8                        and		0xf8
 32+  81F9              ; альтернативная точка входа, A = Y (пиксели)
 33+  81F9              CalcScreenAddrPix:
 34+  81F9 47                           ld		b, a
 35+  81FA                              ; Расчитываем адрес на экране
 36+  81FA 17                           rla                                 ; A = ? |Y5|Y4|Y3| ?| ?| ?| ?
 37+  81FB 17                           rla                                 ; A = Y5|Y4|Y3| ?| ?| ?| ?| ?
 38+  81FC E6 E0                        and     0xe0            ; 1110 0000 ; A = Y5|Y4|Y3| 0| 0| 0| 0| 0
 39+  81FE B1                           or      c               ;             A = Y5|Y4|Y3|X4|X3|X2|X1|X0
 40+  81FF 5F                           ld      e, a
 41+  8200 78                           ld      a, b
 42+  8201 1F                           rra
 43+  8202 1F                           rra
 44+  8203 1F                           rra                                 ; A =  ?| ?| ?|Y7|Y6| ?| ?| ?
 45+  8204 E6 18                        and     0x18                        ; A =  0| 0| 0|Y7|Y6| 0| 0| 0
 46+  8206 57                           ld      d, a
 47+  8207 78                           ld      a, b
 48+  8208 E6 07                        and     0x07                        ; A =  0| 0| 0| 0| 0|Y2|Y1|Y0
 49+  820A B2                           or      d                           ; A =  0| 0| 0|Y7|Y6|Y2|Y1|Y0
 50+  820B FD B4                        or      iyh                         ; A =  0| 1| 0|Y7|Y6|Y2|Y1|Y0
 51+  820D 57                           ld      d, a
 52+  820E C9                           ret
 53+  820F
 54+  820F                              ; Input:
 55+  820F                              ;   C = X (знакоместо)
 56+  820F                              ;   B = Y (знакоместо)
 57+  820F                              ;   D = дополнительный сдвиг по Y (-7..7)
 58+  820F
 59+  820F              DrawEmptyByte:	; Расчитываем адрес назначения
 60+  820F FD 26 40                     ld		iyh, 0x40
 61+  8212 78                           ld		a, b
 62+  8213 87                           add		a, a		; *2
 63+  8214 87                           add		a, a		; *4
 64+  8215 87                           add		a, a		; *8
 65+  8216 82                           add		a, d
 66+  8217 CD F9 81         			call    CalcScreenAddrPix
 67+  821A                  			; Записываем нулевой байт
 68+  821A AF               			xor		a
 69+  821B 12               			ld		(de), a
 70+  821C C9               			ret
 71+  821D
 72+  821D              DRAW_REPLACE 	equ		0			; nop
 73+  821D              DRAW_OR			equ		0xB6		; or (hl)
 74+  821D
 75+  821D                              ; Input:
 76+  821D                              ;   A = mode (DRAW_OR или DRAW_REPLACE)
 77+  821D
 78+  821D 32 89 82     SetDrawCharMode:ld		(DrawChar.hotPatch1), a
 79+  8220 32 97 82     				ld		(DrawChar.hotPatch2), a
 80+  8223 32 A7 82     				ld		(DrawChar.hotPatch3), a
 81+  8226 32 B8 82     				ld		(DrawChar.hotPatch4), a
 82+  8229 32 CA 82     				ld		(DrawChar.hotPatch5), a
 83+  822C 32 DB 82     				ld		(DrawChar.hotPatch6), a
 84+  822F 32 EB 82     				ld		(DrawChar.hotPatch7), a
 85+  8232 32 F9 82     				ld		(DrawChar.hotPatch8), a
 86+  8235 32 04 83     				ld		(DrawChar.hotPatch9), a
 87+  8238 32 11 83     				ld		(DrawChar.hotPatch10), a
 88+  823B 32 20 83     				ld		(DrawChar.hotPatch11), a
 89+  823E 32 30 83     				ld		(DrawChar.hotPatch12), a
 90+  8241 32 41 83     				ld		(DrawChar.hotPatch13), a
 91+  8244 32 51 83     				ld		(DrawChar.hotPatch14), a
 92+  8247 32 60 83     				ld		(DrawChar.hotPatch15), a
 93+  824A 32 6E 83     				ld		(DrawChar.hotPatch16), a
 94+  824D C9           				ret
 95+  824E
 96+  824E                              ; Input:
 97+  824E                              ;	A = атрибут
 98+  824E                              ;   E = дополнительный сдвиг по X (-7..7)
 99+  824E                              ;   D = дополнительный сдвиг по Y (-7..7)
100+  824E                              ;   L = X спрайта (знакоместо)
101+  824E                              ;   H = Y спрайта (знакоместо)
102+  824E                              ;   C = X (знакоместо)
103+  824E                              ;   B = Y (знакоместо)
104+  824E
105+  824E              DrawChar:    	; Сохраняем А
106+  824E 08                           ex      af, af'
107+  824F                              ; Патчим код
108+  824F 7B                           ld		a, e
109+  8250 32 6E 82                     ld		(.hotPatch+2), a
110+  8253              				; Расчитываем адрес назначения
111+  8253 FD 26 40                     ld		iyh, 0x40
112+  8256 78                           ld		a, b
113+  8257 87                           add		a, a		; *2
114+  8258 87                           add		a, a		; *4
115+  8259 87                           add		a, a		; *8
116+  825A 82                           add		a, d
117+  825B CD F9 81         			call    CalcScreenAddrPix
118+  825E D5                           push	de
119+  825F                              ; Преобразуем координату Y спрайта в адрес в SCR
120+  825F 44                           ld		b, h
121+  8260 4D                           ld		c, l
122+  8261 EB                           ex		de, hl		; сохраню DE в HL
123+  8262                              ; Расчитываем адрес спрайта
124+  8262 FD 26 A0                     ld		iyh, high gfx
125+  8265 CD F3 81                     call	CalcScreenAddr
126+  8268
127+  8268 FD 21 7F 82  				ld		iy, .table
128+  826C FD 4E 00     .hotPatch:		ld		c, (iy+0)
129+  826F 06 00        				ld		b, 0
130+  8271 FD 09        				add		iy, bc
131+  8273 06 08                        ld      b, 8		; счетчик для цикла
132+  8275 FD E9        				jp		(iy)
133+  8277
134+  8277 09           				db		.empty-.table
135+  8278 14           				db		.shiftM7-.table
136+  8279 23           				db		.shiftM6-.table
137+  827A 33           				db		.shiftM5-.table
138+  827B 44           				db		.shiftM4-.table
139+  827C 56           				db		.shiftM3-.table
140+  827D 67           				db		.shiftM2-.table
141+  827E 77           				db		.shiftM1-.table
142+  827F 84           .table:			db		.noShift-.table
143+  8280 8F           				db		.shift1-.table
144+  8281 9C           				db		.shift2-.table
145+  8282 AB           				db		.shift3-.table
146+  8283 BB           				db		.shift4-.table
147+  8284 CC           				db		.shift5-.table
148+  8285 DC           				db		.shift6-.table
149+  8286 EB           				db		.shift7-.table
150+  8287 09           				db		.empty-.table
151+  8288
152+  8288 AF           .empty:       	xor		a
153+  8289 00           .hotPatch1:		nop
154+  828A 77           				ld      (hl), a
155+  828B CD 8E 83                     call	DownHL
156+  828E 10 F8                        djnz    .empty
157+  8290 C3 76 83                     jp		.charDone
158+  8293
159+  8293 1A           .shiftM7:       ld      a, (de)
160+  8294 0F           				rrca
161+  8295 E6 80        				and		0x80
162+  8297 00           .hotPatch2:		nop
163+  8298 77                           ld      (hl), a
164+  8299 14                           inc     d
165+  829A CD 8E 83                     call	DownHL
166+  829D 10 F4                        djnz    .shiftM7
167+  829F C3 76 83                     jp		.charDone
168+  82A2
169+  82A2 1A           .shiftM6:       ld      a, (de)
170+  82A3 0F           				rrca
171+  82A4 0F           				rrca
172+  82A5 E6 C0        				and		0xc0
173+  82A7 00           .hotPatch3:		nop
174+  82A8 77                           ld      (hl), a
175+  82A9 14                           inc     d
176+  82AA CD 8E 83                     call	DownHL
177+  82AD 10 F3                        djnz    .shiftM6
178+  82AF C3 76 83                     jp		.charDone
179+  82B2
180+  82B2 1A           .shiftM5:       ld      a, (de)
181+  82B3              				dup		3
182+  82B3 0F          >				rrca
182+  82B4 0F          >				rrca
182+  82B5 0F          >				rrca
183+  82B6              				edup
184+  82B6 E6 E0        				and		0xe0
185+  82B8 00           .hotPatch4:		nop
186+  82B9 77                           ld      (hl), a
187+  82BA 14                           inc     d
188+  82BB CD 8E 83                     call	DownHL
189+  82BE 10 F2                        djnz    .shiftM5
190+  82C0 C3 76 83                     jp		.charDone
191+  82C3
192+  82C3 1A           .shiftM4:       ld      a, (de)
193+  82C4              				dup		4
194+  82C4 07          >				rlca
194+  82C5 07          >				rlca
194+  82C6 07          >				rlca
194+  82C7 07          >				rlca
195+  82C8              				edup
196+  82C8 E6 F0        				and		0xf0
197+  82CA 00           .hotPatch5:		nop
198+  82CB 77                           ld      (hl), a
199+  82CC 14                           inc     d
200+  82CD CD 8E 83                     call	DownHL
201+  82D0 10 F1                        djnz    .shiftM4
202+  82D2 C3 76 83                     jp		.charDone
203+  82D5
204+  82D5 1A           .shiftM3:       ld      a, (de)
205+  82D6              				dup		3
206+  82D6 07          >				rlca
206+  82D7 07          >				rlca
206+  82D8 07          >				rlca
207+  82D9              				edup
208+  82D9 E6 F8        				and		0xf8
209+  82DB 00           .hotPatch6:		nop
210+  82DC 77                           ld      (hl), a
211+  82DD 14                           inc     d
212+  82DE CD 8E 83                     call	DownHL
213+  82E1 10 F2                        djnz    .shiftM3
214+  82E3 C3 76 83                     jp		.charDone
215+  82E6
216+  82E6 1A           .shiftM2:       ld      a, (de)
217+  82E7 07           				rlca
218+  82E8 07           				rlca
219+  82E9 E6 FC        				and		0xfc
220+  82EB 00           .hotPatch7:		nop
221+  82EC 77                           ld      (hl), a
222+  82ED 14                           inc     d
223+  82EE CD 8E 83                     call	DownHL
224+  82F1 10 F3                        djnz    .shiftM2
225+  82F3 C3 76 83                     jp		.charDone
226+  82F6
227+  82F6 1A           .shiftM1:       ld      a, (de)
228+  82F7 CB 27        				sla		a
229+  82F9 00           .hotPatch8:		nop
230+  82FA 77                           ld      (hl), a
231+  82FB 14                           inc     d
232+  82FC CD 8E 83                     call	DownHL
233+  82FF 10 F5                        djnz    .shiftM1
234+  8301 18 73                        jr		.charDone
235+  8303
236+  8303 1A           .noShift:       ld      a, (de)
237+  8304 00           .hotPatch9:		nop
238+  8305 77                           ld      (hl), a
239+  8306 14                           inc     d
240+  8307 CD 8E 83                     call	DownHL
241+  830A 10 F7                        djnz    .noShift
242+  830C 18 68                        jr		.charDone
243+  830E
244+  830E 1A           .shift1:       	ld      a, (de)
245+  830F CB 3F        				srl		a
246+  8311 00           .hotPatch10:	nop
247+  8312 77                           ld      (hl), a
248+  8313 14                           inc     d
249+  8314 CD 8E 83                     call	DownHL
250+  8317 10 F5                        djnz    .shift1
251+  8319 18 5B                        jr		.charDone
252+  831B
253+  831B 1A           .shift2:       	ld      a, (de)
254+  831C 0F           				rrca
255+  831D 0F           				rrca
256+  831E E6 3F        				and		0x3f
257+  8320 00           .hotPatch11:	nop
258+  8321 77                           ld      (hl), a
259+  8322 14                           inc     d
260+  8323 CD 8E 83                     call	DownHL
261+  8326 10 F3                        djnz    .shift2
262+  8328 18 4C                        jr		.charDone
263+  832A
264+  832A 1A           .shift3:       	ld      a, (de)
265+  832B              				dup		3
266+  832B 0F          >				rrca
266+  832C 0F          >				rrca
266+  832D 0F          >				rrca
267+  832E              				edup
268+  832E E6 1F        				and		0x1f
269+  8330 00           .hotPatch12:	nop
270+  8331 77                           ld      (hl), a
271+  8332 14                           inc     d
272+  8333 CD 8E 83                     call	DownHL
273+  8336 10 F2                        djnz    .shift3
274+  8338 18 3C                        jr		.charDone
275+  833A
276+  833A 1A           .shift4:       	ld      a, (de)
277+  833B              				dup		4
278+  833B 0F          >				rrca
278+  833C 0F          >				rrca
278+  833D 0F          >				rrca
278+  833E 0F          >				rrca
279+  833F              				edup
280+  833F E6 0F        				and		0x0f
281+  8341 00           .hotPatch13:	nop
282+  8342 77                           ld      (hl), a
283+  8343 14                           inc     d
284+  8344 CD 8E 83                     call	DownHL
285+  8347 10 F1                        djnz    .shift4
286+  8349 18 2B                        jr		.charDone
287+  834B
288+  834B 1A           .shift5:       	ld      a, (de)
289+  834C              				dup		3
290+  834C 07          >				rlca
290+  834D 07          >				rlca
290+  834E 07          >				rlca
291+  834F              				edup
292+  834F E6 07        				and		0x07
293+  8351 00           .hotPatch14:	nop
294+  8352 77                           ld      (hl), a
295+  8353 14                           inc     d
296+  8354 CD 8E 83                     call	DownHL
297+  8357 10 F2                        djnz    .shift5
298+  8359 18 1B                        jr		.charDone
299+  835B
300+  835B 1A           .shift6:       	ld      a, (de)
301+  835C              				dup		2
302+  835C 07          >				rlca
302+  835D 07          >				rlca
303+  835E              				edup
304+  835E E6 03        				and		0x03
305+  8360 00           .hotPatch15:	nop
306+  8361 77                           ld      (hl), a
307+  8362 14                           inc     d
308+  8363 CD 8E 83                     call	DownHL
309+  8366 10 F3                        djnz    .shift6
310+  8368 18 0C                        jr		.charDone
311+  836A
312+  836A 1A           .shift7:       	ld      a, (de)
313+  836B 07           				rlca
314+  836C E6 01        				and		0x01
315+  836E 00           .hotPatch16:	nop
316+  836F 77                           ld      (hl), a
317+  8370 14                           inc     d
318+  8371 CD 8E 83                     call	DownHL
319+  8374 10 F4                        djnz    .shift7
320+  8376                              ;jr		.charDone
321+  8376
322+  8376              .charDone: 		; Получаем из стека начальный адрес на экране
323+  8376 E1           				pop		hl
324+  8377 4C           				ld		c, h				; сохраняем старший байт в C для проверки внизу
325+  8378              				; Расчитываем адрес в области атрибутов
326+  8378 7C                           ld      a, h
327+  8379 1F                  			rra
328+  837A 1F                           rra
329+  837B 1F                           rra
330+  837C E6 03                        and     0x03
331+  837E F6 58                        or      0x58
332+  8380 67                           ld      h, a
333+  8381                              ; Восстанавливаем A
334+  8381 08                           ex      af, af'
335+  8382                              ; Записываем атрибут
336+  8382 77                           ld      (hl), a
337+  8383                              ; Сохраняем атрибут в B
338+  8383 47                           ld		b, a
339+  8384                              ; Проверяем, нужно ли рисовать второй атрибут
340+  8384 3E 07                        ld		a, 7
341+  8386 A1                           and		c
342+  8387 C8                           ret		z				; мы на границе знакоместа, второй атрибут не нужен
343+  8388              				; Переходим на следующую строку в атрибутах
344+  8388 11 20 00                     ld		de, 32
345+  838B 19                           add		hl, de
346+  838C              				; Записываем второй атрибут
347+  838C 70                           ld		(hl), b
348+  838D C9                           ret
349+  838E
350+  838E                              ; Input:
351+  838E                              ;	HL => адрес байта (8 пикселей) на экране
352+  838E                              ; Output:
353+  838E                              ;   HL => адрес байта (8 пикселей) в следующей строке (Y = Y + 1)
354+  838E
355+  838E 24           DownHL:			inc		h
356+  838F 3E 07        				ld		a, 00000111b	; 7=8-1;  остаток от деления на 8
357+  8391 A4           				and		h
358+  8392 C0           				ret		nz
359+  8393 7D           				ld		a, l			; L = L + 32
360+  8394 D6 E0        				sub		-32
361+  8396 6F           				ld		l, a
362+  8397 9F           				sbc		a, a			; 0 = no carry, -1 (0xff 11111111) = was carry
363+  8398 E6 F8        				and		-8				; 0 = no carry, -8 (0xf8 11111000) = was carry
364+  839A 84           				add		a, h
365+  839B 67           				ld		h, a
366+  839C C9           				ret
367+  839D
# file closed: draw.asm
 43   839D              					include		"input.asm"
# file opened: input.asm
  1+  839D
  2+  839D 01 FE FB     ReadInput:			ld			bc, 0xfbfe
  3+  83A0 ED 78        					in			a, (c)
  4+  83A2 E6 01        					and			1					; Q
  5+  83A4 32 CF 83     					ld			(Input.up), a
  6+  83A7
  7+  83A7 01 FE FD     					ld			bc, 0xfdfe
  8+  83AA ED 78        					in			a, (c)
  9+  83AC E6 01        					and			1					; A
 10+  83AE 32 D0 83     					ld			(Input.down), a
 11+  83B1
 12+  83B1 01 FE DF     					ld			bc, 0xdffe
 13+  83B4 ED 78        					in			a, (c)
 14+  83B6 47           					ld			b, a
 15+  83B7 E6 02        					and			2					; O
 16+  83B9 32 CD 83     					ld			(Input.left), a
 17+  83BC
 18+  83BC 78           					ld			a, b
 19+  83BD E6 01        					and			1					; P
 20+  83BF 32 CE 83     					ld			(Input.right), a
 21+  83C2
 22+  83C2 01 FE 7F     					ld			bc, 0x7ffe
 23+  83C5 ED 78        					in			a, (c)
 24+  83C7 E6 01        					and			1					; Space
 25+  83C9 32 D1 83     					ld			(Input.fire), a
 26+  83CC
 27+  83CC C9           					ret
 28+  83CD
 29+  83CD              Input:
 30+  83CD 01           .left:				db			1
 31+  83CE 01           .right:				db			1
 32+  83CF 01           .up:				db			1
 33+  83D0 01           .down:				db			1
 34+  83D1 01           .fire:				db			1
 35+  83D2
# file closed: input.asm
 44   83D2              					include		"level.asm"
# file opened: level.asm
  1+  83D2
  2+  83D2              LEVEL_WIDTH 		equ		 	32
  3+  83D2              LEVEL_HEIGHT 		equ 		20
  4+  83D2
  5+  83D2              FLOOR_ATTR 			equ 		01001111b
  6+  83D2              SPHERE_ATTR 		equ 		01001110b
  7+  83D2              WALL_ATTR  			equ 		00001101b
  8+  83D2
  9+  83D2              					; пробел - пустое место
 10+  83D2              					; X - стена
 11+  83D2              					; 1 - точка старта
 12+  83D2
 13+  83D2 58 58 58 58  Level:				db			"XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"
 13+  83D6 58 58 58 58
 13+  83DA 58 58 58 58
 13+  83DE 58 58 58 58
 13+  83E2 58 58 58 58
 13+  83E6 58 58 58 58
 13+  83EA 58 58 58 58
 13+  83EE 58 58 58 58
 14+  83F2 58 20 20 20  					db			"X                              X"
 14+  83F6 20 20 20 20
 14+  83FA 20 20 20 20
 14+  83FE 20 20 20 20
 14+  8402 20 20 20 20
 14+  8406 20 20 20 20
 14+  840A 20 20 20 20
 14+  840E 20 20 20 58
 15+  8412 58 20 20 20  					db			"X                              X"
 15+  8416 20 20 20 20
 15+  841A 20 20 20 20
 15+  841E 20 20 20 20
 15+  8422 20 20 20 20
 15+  8426 20 20 20 20
 15+  842A 20 20 20 20
 15+  842E 20 20 20 58
 16+  8432 58 20 20 20  					db			"X                      O       X"
 16+  8436 20 20 20 20
 16+  843A 20 20 20 20
 16+  843E 20 20 20 20
 16+  8442 20 20 20 20
 16+  8446 20 20 20 4F
 16+  844A 20 20 20 20
 16+  844E 20 20 20 58
 17+  8452 58 20 20 20  					db			"X   O                          X"
 17+  8456 4F 20 20 20
 17+  845A 20 20 20 20
 17+  845E 20 20 20 20
 17+  8462 20 20 20 20
 17+  8466 20 20 20 20
 17+  846A 20 20 20 20
 17+  846E 20 20 20 58
 18+  8472 58 20 20 20  					db			"X                              X"
 18+  8476 20 20 20 20
 18+  847A 20 20 20 20
 18+  847E 20 20 20 20
 18+  8482 20 20 20 20
 18+  8486 20 20 20 20
 18+  848A 20 20 20 20
 18+  848E 20 20 20 58
 19+  8492 58 20 20 20  					db			"X        1                     X"
 19+  8496 20 20 20 20
 19+  849A 20 31 20 20
 19+  849E 20 20 20 20
 19+  84A2 20 20 20 20
 19+  84A6 20 20 20 20
 19+  84AA 20 20 20 20
 19+  84AE 20 20 20 58
 20+  84B2 58 20 20 20  					db			"X                              X"
 20+  84B6 20 20 20 20
 20+  84BA 20 20 20 20
 20+  84BE 20 20 20 20
 20+  84C2 20 20 20 20
 20+  84C6 20 20 20 20
 20+  84CA 20 20 20 20
 20+  84CE 20 20 20 58
 21+  84D2 58 20 20 20  					db			"X           O                  X"
 21+  84D6 20 20 20 20
 21+  84DA 20 20 20 20
 21+  84DE 4F 20 20 20
 21+  84E2 20 20 20 20
 21+  84E6 20 20 20 20
 21+  84EA 20 20 20 20
 21+  84EE 20 20 20 58
 22+  84F2 58 20 20 20  					db			"X                        O     X"
 22+  84F6 20 20 20 20
 22+  84FA 20 20 20 20
 22+  84FE 20 20 20 20
 22+  8502 20 20 20 20
 22+  8506 20 20 20 20
 22+  850A 20 4F 20 20
 22+  850E 20 20 20 58
 23+  8512 58 20 20 20  					db			"X              O               X"
 23+  8516 20 20 20 20
 23+  851A 20 20 20 20
 23+  851E 20 20 20 4F
 23+  8522 20 20 20 20
 23+  8526 20 20 20 20
 23+  852A 20 20 20 20
 23+  852E 20 20 20 58
 24+  8532 58 20 20 20  					db			"X                              X"
 24+  8536 20 20 20 20
 24+  853A 20 20 20 20
 24+  853E 20 20 20 20
 24+  8542 20 20 20 20
 24+  8546 20 20 20 20
 24+  854A 20 20 20 20
 24+  854E 20 20 20 58
 25+  8552 58 20 20 20  					db			"X                              X"
 25+  8556 20 20 20 20
 25+  855A 20 20 20 20
 25+  855E 20 20 20 20
 25+  8562 20 20 20 20
 25+  8566 20 20 20 20
 25+  856A 20 20 20 20
 25+  856E 20 20 20 58
 26+  8572 58 20 58 58  					db			"X XXX XXX X X XXX XXX  X  XX X X"
 26+  8576 58 20 58 58
 26+  857A 58 20 58 20
 26+  857E 58 20 58 58
 26+  8582 58 20 58 58
 26+  8586 58 20 20 58
 26+  858A 20 20 58 58
 26+  858E 20 58 20 58
 27+  8592 58 20 58 20  					db			"X X   X X X X X X X X X X XX X X"
 27+  8596 20 20 58 20
 27+  859A 58 20 58 20
 27+  859E 58 20 58 20
 27+  85A2 58 20 58 20
 27+  85A6 58 20 58 20
 27+  85AA 58 20 58 58
 27+  85AE 20 58 20 58
 28+  85B2 58 20 58 58  					db			"X XXX X X XX  X X XX  XXX X XX X"
 28+  85B6 58 20 58 20
 28+  85BA 58 20 58 58
 28+  85BE 20 20 58 20
 28+  85C2 58 20 58 58
 28+  85C6 20 20 58 58
 28+  85CA 58 20 58 20
 28+  85CE 58 58 20 58
 29+  85D2 58 20 20 20  					db			"X   X X X X X X X X X X X X XX X"
 29+  85D6 58 20 58 20
 29+  85DA 58 20 58 20
 29+  85DE 58 20 58 20
 29+  85E2 58 20 58 20
 29+  85E6 58 20 58 20
 29+  85EA 58 20 58 20
 29+  85EE 58 58 20 58
 30+  85F2 58 20 58 58  					db			"X XXX XXX X X XXX XXX X X X  X X"
 30+  85F6 58 20 58 58
 30+  85FA 58 20 58 20
 30+  85FE 58 20 58 58
 30+  8602 58 20 58 58
 30+  8606 58 20 58 20
 30+  860A 58 20 58 20
 30+  860E 20 58 20 58
 31+  8612 58 20 20 20  					db			"X                              X"
 31+  8616 20 20 20 20
 31+  861A 20 20 20 20
 31+  861E 20 20 20 20
 31+  8622 20 20 20 20
 31+  8626 20 20 20 20
 31+  862A 20 20 20 20
 31+  862E 20 20 20 58
 32+  8632 58 58 58 58  					db			"XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"
 32+  8636 58 58 58 58
 32+  863A 58 58 58 58
 32+  863E 58 58 58 58
 32+  8642 58 58 58 58
 32+  8646 58 58 58 58
 32+  864A 58 58 58 58
 32+  864E 58 58 58 58
 33+  8652              LevelEnd:
 34+  8652
 35+  8652 21 52 86     InitLevel:			ld			hl, LevelEnd
 36+  8655 0E 14        					ld			c, LEVEL_HEIGHT
 37+  8657 06 20        .rowLoop:			ld			b, LEVEL_WIDTH
 38+  8659 2B           .colLoop:			dec			hl
 39+  865A 7E           					ld			a, (hl)
 40+  865B FE 31        					cp			a, '1'
 41+  865D CC 66 86     					call		z, .handlePlayerStart
 42+  8660 10 F7        					djnz		.colLoop
 43+  8662 0D           					dec			c
 44+  8663 20 F2        					jr			nz, .rowLoop
 45+  8665 C9           					ret
 46+  8666 36 20        .handlePlayerStart:	ld			(hl), ' '
 47+  8668 78           					ld			a, b
 48+  8669 3D           					dec			a
 49+  866A 32 C9 86     					ld			(player1.x), a
 50+  866D 79           					ld			a, c
 51+  866E 3D           					dec			a
 52+  866F 32 CA 86     					ld			(player1.y), a
 53+  8672 C9           					ret
 54+  8673
 55+  8673 21 52 86     DrawLevel:			ld			hl, LevelEnd
 56+  8676 06 14        					ld			b, LEVEL_HEIGHT
 57+  8678 0E 20        .rowLoop:			ld			c, LEVEL_WIDTH
 58+  867A 2B           .colLoop:			dec			hl
 59+  867B 7E           					ld			a, (hl)
 60+  867C FE 20        					cp			a, ' '
 61+  867E CC 91 86     					call		z, .drawFloor
 62+  8681 FE 58        					cp			a, 'X'
 63+  8683 CC 9F 86     					call		z, .drawWall
 64+  8686 FE 4F        					cp			a, 'O'
 65+  8688 CC 98 86     					call		z, .drawSphere
 66+  868B 0D           					dec			c
 67+  868C 20 EC        					jr			nz, .colLoop
 68+  868E 10 E8        					djnz		.rowLoop
 69+  8690 C9           					ret
 70+  8691 3E 4F        .drawFloor:			ld			a, FLOOR_ATTR
 71+  8693 11 01 02     					ld			de, 0x201
 72+  8696 18 0C        					jr			.drawChar
 73+  8698 3E 4E        .drawSphere:		ld			a, SPHERE_ATTR
 74+  869A 11 00 01     					ld			de, 0x100
 75+  869D 18 05        					jr			.drawChar
 76+  869F 3E 0D        .drawWall:			ld			a, WALL_ATTR
 77+  86A1 11 00 02     					ld			de, 0x200
 78+  86A4              					;jr			.drawChar
 79+  86A4 C5           .drawChar:			push		bc
 80+  86A5 E5           					push		hl
 81+  86A6 05           					dec			b
 82+  86A7 0D           					dec			c
 83+  86A8 21 00 00     					ld			hl, 0
 84+  86AB EB           					ex			de, hl
 85+  86AC CD 4E 82     					call		DrawChar
 86+  86AF E1           					pop			hl
 87+  86B0 C1           					pop			bc
 88+  86B1 C9           					ret
 89+  86B2
 90+  86B2              					; Input:
 91+  86B2              	                ;   C = X (знакоместо)
 92+  86B2                  	            ;   B = Y (знакоместо)
 93+  86B2                  	            ; Output:
 94+  86B2                  	            ;	A = предмет на карте
 95+  86B2                  	            ;   ZF=0 если ходить нельзя, ZF=1 если ходить можно
 96+  86B2
 97+  86B2 CD B9 86     CheckBlocked:		call		GetLevelAddr
 98+  86B5 7E           					ld			a, (hl)
 99+  86B6 FE 20        					cp			a, ' '
100+  86B8 C9           					ret
101+  86B9
102+  86B9              					; Input:
103+  86B9              	                ;   C = X (знакоместо)
104+  86B9                  	            ;   B = Y (знакоместо)
105+  86B9                  	            ; Output:
106+  86B9                  	            ;	HL => адрес внутри Level
107+  86B9
108+  86B9              GetLevelAddr:		; HL = B * 32 + C; 32 = LEVEL_WIDTH
109+  86B9 68           					ld			l, b
110+  86BA 26 00        					ld			h, 0
111+  86BC 59           					ld			e, c
112+  86BD 54           					ld			d, h
113+  86BE 29           					add			hl, hl			; *2
114+  86BF 29           					add			hl, hl			; *4
115+  86C0 29           					add			hl, hl			; *8
116+  86C1 29           					add			hl, hl			; *16
117+  86C2 29           					add			hl, hl			; *32
118+  86C3 19           					add			hl, de
119+  86C4 11 D2 83     					ld			de, Level
120+  86C7 19           					add			hl, de
121+  86C8 C9           					ret
122+  86C9
# file closed: level.asm
 45   86C9              					include		"player.asm"
# file opened: player.asm
  1+  86C9
  2+  86C9              PLAYER_IDLE			equ			0
  3+  86C9              PLAYER_GO_LEFT		equ			3
  4+  86C9              PLAYER_GO_RIGHT		equ			6
  5+  86C9              PLAYER_GO_UP		equ			9
  6+  86C9              PLAYER_GO_DOWN		equ			12
  7+  86C9              PLAYER_SHIFT_LEFT	equ			15
  8+  86C9              PLAYER_SHIFT_RIGHT	equ			18
  9+  86C9              PLAYER_SHIFT_UP		equ			21
 10+  86C9              PLAYER_SHIFT_DOWN	equ			24
 11+  86C9
 12+  86C9              ;PLAYER_MAX_X		equ 		31
 13+  86C9              ;PLAYER_MAX_Y		equ			23
 14+  86C9
 15+  86C9              PLAYER_MOVE_DELAY_BITS equ		1
 16+  86C9
 17+  86C9              PLAYER_ATTR			equ			FLOOR_ATTR
 18+  86C9
 19+  86C9              					struct 		SPLAYER
 20+  86C9 ~            x 					byte
 21+  86C9 ~            y 					byte
 22+  86C9 ~            state				byte
 23+  86C9 ~            time				byte
 24+  86C9              					ends
 25+  86C9
 26+  86C9 05 02 00 00  player1:			SPLAYER		5,2,PLAYER_IDLE,0
 27+  86CD
 28+  86CD DD 36 02 00  InitPlayer:			ld			(ix+SPLAYER.state), PLAYER_IDLE
 29+  86D1 C9           					ret
 30+  86D2
 31+  86D2              ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 32+  86D2
 33+  86D2              					macro		DRAWHORZ left, shift
 34+  86D2 ~
 35+  86D2 ~            					ld			a, (ix+SPLAYER.time)
 36+  86D2 ~            					dup			PLAYER_MOVE_DELAY_BITS
 37+  86D2 ~            					rrca
 38+  86D2 ~            					edup
 39+  86D2 ~            					and			(1<<(8-PLAYER_MOVE_DELAY_BITS))-1
 40+  86D2 ~            					inc			a
 41+  86D2 ~            				if left
 42+  86D2 ~            					neg
 43+  86D2 ~            				endif
 44+  86D2 ~            					ld			e, a
 45+  86D2 ~
 46+  86D2 ~            				if shift
 47+  86D2 ~            					and			3
 48+  86D2 ~            					ld			h, 0x01
 49+  86D2 ~            					ld			l, a
 50+  86D2 ~            					ld			d, 0
 51+  86D2 ~
 52+  86D2 ~            					push		af
 53+  86D2 ~
 54+  86D2 ~            					push		bc
 55+  86D2 ~            					push		de
 56+  86D2 ~            					push		hl
 57+  86D2 ~            					ld			a, SPHERE_ATTR
 58+  86D2 ~            					call		DrawChar
 59+  86D2 ~            					pop			hl
 60+  86D2 ~            					pop			de
 61+  86D2 ~            					pop			bc
 62+  86D2 ~
 63+  86D2 ~            					push		bc
 64+  86D2 ~            					push		de
 65+  86D2 ~            				if left
 66+  86D2 ~            					dec			c
 67+  86D2 ~            					ld			a, 8
 68+  86D2 ~            					add			a, e
 69+  86D2 ~            				else
 70+  86D2 ~            					inc			c
 71+  86D2 ~            					ld			a, e
 72+  86D2 ~            					sub			8
 73+  86D2 ~            				endif
 74+  86D2 ~            					ld			e, a
 75+  86D2 ~            					ld			a, SPHERE_ATTR
 76+  86D2 ~            					call		DrawChar
 77+  86D2 ~            					pop			de
 78+  86D2 ~            					pop			bc
 79+  86D2 ~
 80+  86D2 ~            					pop			af
 81+  86D2 ~            				endif ; shift
 82+  86D2 ~
 83+  86D2 ~            					rrca
 84+  86D2 ~            					and			1
 85+  86D2 ~            				if left
 86+  86D2 ~            					inc			a
 87+  86D2 ~            				else
 88+  86D2 ~            					add			a, 3
 89+  86D2 ~            				endif
 90+  86D2 ~            					ld			l, a
 91+  86D2 ~            					ld			h, 0
 92+  86D2 ~            					ld			d, h
 93+  86D2 ~
 94+  86D2 ~            					push		hl
 95+  86D2 ~            					push		de
 96+  86D2 ~            					push		bc
 97+  86D2 ~            					ld			a, PLAYER_ATTR
 98+  86D2 ~            				if left
 99+  86D2 ~            					inc			c
100+  86D2 ~            				else
101+  86D2 ~            					dec			c
102+  86D2 ~            				endif
103+  86D2 ~            					call		DrawChar
104+  86D2 ~            					pop			bc
105+  86D2 ~            					pop			de
106+  86D2 ~            					pop			hl
107+  86D2 ~
108+  86D2 ~            				if shift
109+  86D2 ~            					ld			a, DRAW_OR
110+  86D2 ~            					call		SetDrawCharMode
111+  86D2 ~            				endif
112+  86D2 ~
113+  86D2 ~            					ld			a, e
114+  86D2 ~            				if left
115+  86D2 ~            					add			a, 8
116+  86D2 ~            				else
117+  86D2 ~            					sub			8
118+  86D2 ~            				endif
119+  86D2 ~            					ld			e, a
120+  86D2 ~            					ld			a, PLAYER_ATTR
121+  86D2 ~            				if shift
122+  86D2 ~            					call		DrawChar
123+  86D2 ~            					ld			a, DRAW_REPLACE
124+  86D2 ~            					jp			SetDrawCharMode
125+  86D2 ~            				else
126+  86D2 ~            					jp			DrawChar
127+  86D2 ~            				endif
128+  86D2 ~
129+  86D2              					endm
130+  86D2
131+  86D2              ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
132+  86D2
133+  86D2              					macro		DRAWVERT up, shift
134+  86D2 ~
135+  86D2 ~            					ld			a, (ix+SPLAYER.time)
136+  86D2 ~            					dup			PLAYER_MOVE_DELAY_BITS
137+  86D2 ~            					rrca
138+  86D2 ~            					edup
139+  86D2 ~            					and			(1<<(8-PLAYER_MOVE_DELAY_BITS))-1
140+  86D2 ~            					inc			a
141+  86D2 ~            				if up
142+  86D2 ~            					neg
143+  86D2 ~            				endif
144+  86D2 ~            					ld			d, a
145+  86D2 ~            					ld			e, 0
146+  86D2 ~
147+  86D2 ~            					and			3
148+  86D2 ~
149+  86D2 ~            				if shift
150+  86D2 ~            					push		af
151+  86D2 ~            					push		de
152+  86D2 ~            					push		bc
153+  86D2 ~            					ld			h, 1
154+  86D2 ~            					ld			l, a
155+  86D2 ~            					ld			a, SPHERE_ATTR
156+  86D2 ~            					call		DrawChar
157+  86D2 ~            					pop			bc
158+  86D2 ~            					pop			de
159+  86D2 ~            					pop			af
160+  86D2 ~            			 	endif ; shift
161+  86D2 ~
162+  86D2 ~            					add			a, 5
163+  86D2 ~            					ld			l, a
164+  86D2 ~            					ld			h, e
165+  86D2 ~
166+  86D2 ~            					ld			a, PLAYER_ATTR
167+  86D2 ~            				if up
168+  86D2 ~            					inc			b
169+  86D2 ~            					push		de
170+  86D2 ~            					push		bc
171+  86D2 ~            					call		DrawChar
172+  86D2 ~            					pop			bc
173+  86D2 ~            					pop			de
174+  86D2 ~
175+  86D2 ~            					ld			a, 8
176+  86D2 ~            					add			a, d
177+  86D2 ~            					ld			d, a
178+  86D2 ~            					jp			DrawEmptyByte
179+  86D2 ~            				else
180+  86D2 ~            					dec			b
181+  86D2 ~            					jp			DrawChar
182+  86D2 ~            				endif
183+  86D2 ~
184+  86D2              					endm
185+  86D2
186+  86D2              ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
187+  86D2
188+  86D2 DD 4E 00     DrawPlayer:			ld			c, (ix+SPLAYER.x)
189+  86D5 DD 46 01     					ld			b, (ix+SPLAYER.y)
190+  86D8
191+  86D8 DD 6E 02     					ld			l, (ix+SPLAYER.state)
192+  86DB 26 00        					ld			h, 0
193+  86DD 11 E2 86     					ld			de, .jumpTable
194+  86E0 19           					add			hl, de
195+  86E1 E9           					jp			(hl)
196+  86E2 C3 FD 86     .jumpTable:			jp			.drawIdle
197+  86E5 C3 27 88     					jp			.drawLeft
198+  86E8 C3 01 88     					jp			.drawRight
199+  86EB C3 64 88     					jp			.drawUp
200+  86EE C3 4E 88     					jp			.drawDown
201+  86F1 C3 07 87     					jp			.drawShiftLeft
202+  86F4 C3 5A 87     					jp			.drawShiftRight
203+  86F7 C3 AC 87     					jp			.drawShiftUp
204+  86FA C3 DD 87     					jp			.drawShiftDown
205+  86FD
206+  86FD 21 00 00     .drawIdle:			ld			hl, 0x0000
207+  8700 54           					ld			d, h
208+  8701 5C           					ld			e, h
209+  8702 3E 4F        					ld			a, PLAYER_ATTR
210+  8704 C3 4E 82     					jp			DrawChar
211+  8707
212+  8707              .drawShiftLeft:		DRAWHORZ 	1, 1
212+  8707             >
212+  8707 DD 7E 03    >					ld			a, (ix+SPLAYER.time)
212+  870A             >					dup			PLAYER_MOVE_DELAY_BITS
212+  870A 0F          >					rrca
212+  870B             >					edup
212+  870B E6 7F       >					and			(1<<(8-PLAYER_MOVE_DELAY_BITS))-1
212+  870D 3C          >					inc			a
212+  870E             >				if 1
212+  870E ED 44       >					neg
212+  8710             >				endif
212+  8710 5F          >					ld			e, a
212+  8711             >
212+  8711             >				if 1
212+  8711 E6 03       >					and			3
212+  8713 26 01       >					ld			h, 0x01
212+  8715 6F          >					ld			l, a
212+  8716 16 00       >					ld			d, 0
212+  8718             >
212+  8718 F5          >					push		af
212+  8719             >
212+  8719 C5          >					push		bc
212+  871A D5          >					push		de
212+  871B E5          >					push		hl
212+  871C 3E 4E       >					ld			a, SPHERE_ATTR
212+  871E CD 4E 82    >					call		DrawChar
212+  8721 E1          >					pop			hl
212+  8722 D1          >					pop			de
212+  8723 C1          >					pop			bc
212+  8724             >
212+  8724 C5          >					push		bc
212+  8725 D5          >					push		de
212+  8726             >				if 1
212+  8726 0D          >					dec			c
212+  8727 3E 08       >					ld			a, 8
212+  8729 83          >					add			a, e
212+  872A             >				else
212+  872A ~           >					inc			c
212+  872A ~           >					ld			a, e
212+  872A ~           >					sub			8
212+  872A             >				endif
212+  872A 5F          >					ld			e, a
212+  872B 3E 4E       >					ld			a, SPHERE_ATTR
212+  872D CD 4E 82    >					call		DrawChar
212+  8730 D1          >					pop			de
212+  8731 C1          >					pop			bc
212+  8732             >
212+  8732 F1          >					pop			af
212+  8733             >				endif ; shift
212+  8733             >
212+  8733 0F          >					rrca
212+  8734 E6 01       >					and			1
212+  8736             >				if 1
212+  8736 3C          >					inc			a
212+  8737             >				else
212+  8737 ~           >					add			a, 3
212+  8737             >				endif
212+  8737 6F          >					ld			l, a
212+  8738 26 00       >					ld			h, 0
212+  873A 54          >					ld			d, h
212+  873B             >
212+  873B E5          >					push		hl
212+  873C D5          >					push		de
212+  873D C5          >					push		bc
212+  873E 3E 4F       >					ld			a, PLAYER_ATTR
212+  8740             >				if 1
212+  8740 0C          >					inc			c
212+  8741             >				else
212+  8741 ~           >					dec			c
212+  8741             >				endif
212+  8741 CD 4E 82    >					call		DrawChar
212+  8744 C1          >					pop			bc
212+  8745 D1          >					pop			de
212+  8746 E1          >					pop			hl
212+  8747             >
212+  8747             >				if 1
212+  8747 3E B6       >					ld			a, DRAW_OR
212+  8749 CD 1D 82    >					call		SetDrawCharMode
212+  874C             >				endif
212+  874C             >
212+  874C 7B          >					ld			a, e
212+  874D             >				if 1
212+  874D C6 08       >					add			a, 8
212+  874F             >				else
212+  874F ~           >					sub			8
212+  874F             >				endif
212+  874F 5F          >					ld			e, a
212+  8750 3E 4F       >					ld			a, PLAYER_ATTR
212+  8752             >				if 1
212+  8752 CD 4E 82    >					call		DrawChar
212+  8755 3E 00       >					ld			a, DRAW_REPLACE
212+  8757 C3 1D 82    >					jp			SetDrawCharMode
212+  875A             >				else
212+  875A ~           >					jp			DrawChar
212+  875A             >				endif
212+  875A             >
213+  875A              .drawShiftRight:	DRAWHORZ 	0, 1
213+  875A             >
213+  875A DD 7E 03    >					ld			a, (ix+SPLAYER.time)
213+  875D             >					dup			PLAYER_MOVE_DELAY_BITS
213+  875D 0F          >					rrca
213+  875E             >					edup
213+  875E E6 7F       >					and			(1<<(8-PLAYER_MOVE_DELAY_BITS))-1
213+  8760 3C          >					inc			a
213+  8761             >				if 0
213+  8761 ~           >					neg
213+  8761             >				endif
213+  8761 5F          >					ld			e, a
213+  8762             >
213+  8762             >				if 1
213+  8762 E6 03       >					and			3
213+  8764 26 01       >					ld			h, 0x01
213+  8766 6F          >					ld			l, a
213+  8767 16 00       >					ld			d, 0
213+  8769             >
213+  8769 F5          >					push		af
213+  876A             >
213+  876A C5          >					push		bc
213+  876B D5          >					push		de
213+  876C E5          >					push		hl
213+  876D 3E 4E       >					ld			a, SPHERE_ATTR
213+  876F CD 4E 82    >					call		DrawChar
213+  8772 E1          >					pop			hl
213+  8773 D1          >					pop			de
213+  8774 C1          >					pop			bc
213+  8775             >
213+  8775 C5          >					push		bc
213+  8776 D5          >					push		de
213+  8777             >				if 0
213+  8777 ~           >					dec			c
213+  8777 ~           >					ld			a, 8
213+  8777 ~           >					add			a, e
213+  8777             >				else
213+  8777 0C          >					inc			c
213+  8778 7B          >					ld			a, e
213+  8779 D6 08       >					sub			8
213+  877B             >				endif
213+  877B 5F          >					ld			e, a
213+  877C 3E 4E       >					ld			a, SPHERE_ATTR
213+  877E CD 4E 82    >					call		DrawChar
213+  8781 D1          >					pop			de
213+  8782 C1          >					pop			bc
213+  8783             >
213+  8783 F1          >					pop			af
213+  8784             >				endif ; shift
213+  8784             >
213+  8784 0F          >					rrca
213+  8785 E6 01       >					and			1
213+  8787             >				if 0
213+  8787 ~           >					inc			a
213+  8787             >				else
213+  8787 C6 03       >					add			a, 3
213+  8789             >				endif
213+  8789 6F          >					ld			l, a
213+  878A 26 00       >					ld			h, 0
213+  878C 54          >					ld			d, h
213+  878D             >
213+  878D E5          >					push		hl
213+  878E D5          >					push		de
213+  878F C5          >					push		bc
213+  8790 3E 4F       >					ld			a, PLAYER_ATTR
213+  8792             >				if 0
213+  8792 ~           >					inc			c
213+  8792             >				else
213+  8792 0D          >					dec			c
213+  8793             >				endif
213+  8793 CD 4E 82    >					call		DrawChar
213+  8796 C1          >					pop			bc
213+  8797 D1          >					pop			de
213+  8798 E1          >					pop			hl
213+  8799             >
213+  8799             >				if 1
213+  8799 3E B6       >					ld			a, DRAW_OR
213+  879B CD 1D 82    >					call		SetDrawCharMode
213+  879E             >				endif
213+  879E             >
213+  879E 7B          >					ld			a, e
213+  879F             >				if 0
213+  879F ~           >					add			a, 8
213+  879F             >				else
213+  879F D6 08       >					sub			8
213+  87A1             >				endif
213+  87A1 5F          >					ld			e, a
213+  87A2 3E 4F       >					ld			a, PLAYER_ATTR
213+  87A4             >				if 1
213+  87A4 CD 4E 82    >					call		DrawChar
213+  87A7 3E 00       >					ld			a, DRAW_REPLACE
213+  87A9 C3 1D 82    >					jp			SetDrawCharMode
213+  87AC             >				else
213+  87AC ~           >					jp			DrawChar
213+  87AC             >				endif
213+  87AC             >
214+  87AC              .drawShiftUp:		DRAWVERT	1, 1
214+  87AC             >
214+  87AC DD 7E 03    >					ld			a, (ix+SPLAYER.time)
214+  87AF             >					dup			PLAYER_MOVE_DELAY_BITS
214+  87AF 0F          >					rrca
214+  87B0             >					edup
214+  87B0 E6 7F       >					and			(1<<(8-PLAYER_MOVE_DELAY_BITS))-1
214+  87B2 3C          >					inc			a
214+  87B3             >				if 1
214+  87B3 ED 44       >					neg
214+  87B5             >				endif
214+  87B5 57          >					ld			d, a
214+  87B6 1E 00       >					ld			e, 0
214+  87B8             >
214+  87B8 E6 03       >					and			3
214+  87BA             >
214+  87BA             >				if 1
214+  87BA F5          >					push		af
214+  87BB D5          >					push		de
214+  87BC C5          >					push		bc
214+  87BD 26 01       >					ld			h, 1
214+  87BF 6F          >					ld			l, a
214+  87C0 3E 4E       >					ld			a, SPHERE_ATTR
214+  87C2 CD 4E 82    >					call		DrawChar
214+  87C5 C1          >					pop			bc
214+  87C6 D1          >					pop			de
214+  87C7 F1          >					pop			af
214+  87C8             >			 	endif ; shift
214+  87C8             >
214+  87C8 C6 05       >					add			a, 5
214+  87CA 6F          >					ld			l, a
214+  87CB 63          >					ld			h, e
214+  87CC             >
214+  87CC 3E 4F       >					ld			a, PLAYER_ATTR
214+  87CE             >				if 1
214+  87CE 04          >					inc			b
214+  87CF D5          >					push		de
214+  87D0 C5          >					push		bc
214+  87D1 CD 4E 82    >					call		DrawChar
214+  87D4 C1          >					pop			bc
214+  87D5 D1          >					pop			de
214+  87D6             >
214+  87D6 3E 08       >					ld			a, 8
214+  87D8 82          >					add			a, d
214+  87D9 57          >					ld			d, a
214+  87DA C3 0F 82    >					jp			DrawEmptyByte
214+  87DD             >				else
214+  87DD ~           >					dec			b
214+  87DD ~           >					jp			DrawChar
214+  87DD             >				endif
214+  87DD             >
215+  87DD              .drawShiftDown:		DRAWVERT	0, 1
215+  87DD             >
215+  87DD DD 7E 03    >					ld			a, (ix+SPLAYER.time)
215+  87E0             >					dup			PLAYER_MOVE_DELAY_BITS
215+  87E0 0F          >					rrca
215+  87E1             >					edup
215+  87E1 E6 7F       >					and			(1<<(8-PLAYER_MOVE_DELAY_BITS))-1
215+  87E3 3C          >					inc			a
215+  87E4             >				if 0
215+  87E4 ~           >					neg
215+  87E4             >				endif
215+  87E4 57          >					ld			d, a
215+  87E5 1E 00       >					ld			e, 0
215+  87E7             >
215+  87E7 E6 03       >					and			3
215+  87E9             >
215+  87E9             >				if 1
215+  87E9 F5          >					push		af
215+  87EA D5          >					push		de
215+  87EB C5          >					push		bc
215+  87EC 26 01       >					ld			h, 1
215+  87EE 6F          >					ld			l, a
215+  87EF 3E 4E       >					ld			a, SPHERE_ATTR
215+  87F1 CD 4E 82    >					call		DrawChar
215+  87F4 C1          >					pop			bc
215+  87F5 D1          >					pop			de
215+  87F6 F1          >					pop			af
215+  87F7             >			 	endif ; shift
215+  87F7             >
215+  87F7 C6 05       >					add			a, 5
215+  87F9 6F          >					ld			l, a
215+  87FA 63          >					ld			h, e
215+  87FB             >
215+  87FB 3E 4F       >					ld			a, PLAYER_ATTR
215+  87FD             >				if 0
215+  87FD ~           >					inc			b
215+  87FD ~           >					push		de
215+  87FD ~           >					push		bc
215+  87FD ~           >					call		DrawChar
215+  87FD ~           >					pop			bc
215+  87FD ~           >					pop			de
215+  87FD ~           >
215+  87FD ~           >					ld			a, 8
215+  87FD ~           >					add			a, d
215+  87FD ~           >					ld			d, a
215+  87FD ~           >					jp			DrawEmptyByte
215+  87FD             >				else
215+  87FD 05          >					dec			b
215+  87FE C3 4E 82    >					jp			DrawChar
215+  8801             >				endif
215+  8801             >
216+  8801
217+  8801              .drawRight:			DRAWHORZ	0, 0
217+  8801             >
217+  8801 DD 7E 03    >					ld			a, (ix+SPLAYER.time)
217+  8804             >					dup			PLAYER_MOVE_DELAY_BITS
217+  8804 0F          >					rrca
217+  8805             >					edup
217+  8805 E6 7F       >					and			(1<<(8-PLAYER_MOVE_DELAY_BITS))-1
217+  8807 3C          >					inc			a
217+  8808             >				if 0
217+  8808 ~           >					neg
217+  8808             >				endif
217+  8808 5F          >					ld			e, a
217+  8809             >
217+  8809             >				if 0
217+  8809 ~           >					and			3
217+  8809 ~           >					ld			h, 0x01
217+  8809 ~           >					ld			l, a
217+  8809 ~           >					ld			d, 0
217+  8809 ~           >
217+  8809 ~           >					push		af
217+  8809 ~           >
217+  8809 ~           >					push		bc
217+  8809 ~           >					push		de
217+  8809 ~           >					push		hl
217+  8809 ~           >					ld			a, SPHERE_ATTR
217+  8809 ~           >					call		DrawChar
217+  8809 ~           >					pop			hl
217+  8809 ~           >					pop			de
217+  8809 ~           >					pop			bc
217+  8809 ~           >
217+  8809 ~           >					push		bc
217+  8809 ~           >					push		de
217+  8809 ~           >				if left
217+  8809 ~           >					dec			c
217+  8809 ~           >					ld			a, 8
217+  8809 ~           >					add			a, e
217+  8809 ~           >				else
217+  8809 ~           >					inc			c
217+  8809 ~           >					ld			a, e
217+  8809 ~           >					sub			8
217+  8809 ~           >				endif
217+  8809 ~           >					ld			e, a
217+  8809 ~           >					ld			a, SPHERE_ATTR
217+  8809 ~           >					call		DrawChar
217+  8809 ~           >					pop			de
217+  8809 ~           >					pop			bc
217+  8809 ~           >
217+  8809 ~           >					pop			af
217+  8809             >				endif ; shift
217+  8809             >
217+  8809 0F          >					rrca
217+  880A E6 01       >					and			1
217+  880C             >				if 0
217+  880C ~           >					inc			a
217+  880C             >				else
217+  880C C6 03       >					add			a, 3
217+  880E             >				endif
217+  880E 6F          >					ld			l, a
217+  880F 26 00       >					ld			h, 0
217+  8811 54          >					ld			d, h
217+  8812             >
217+  8812 E5          >					push		hl
217+  8813 D5          >					push		de
217+  8814 C5          >					push		bc
217+  8815 3E 4F       >					ld			a, PLAYER_ATTR
217+  8817             >				if 0
217+  8817 ~           >					inc			c
217+  8817             >				else
217+  8817 0D          >					dec			c
217+  8818             >				endif
217+  8818 CD 4E 82    >					call		DrawChar
217+  881B C1          >					pop			bc
217+  881C D1          >					pop			de
217+  881D E1          >					pop			hl
217+  881E             >
217+  881E             >				if 0
217+  881E ~           >					ld			a, DRAW_OR
217+  881E ~           >					call		SetDrawCharMode
217+  881E             >				endif
217+  881E             >
217+  881E 7B          >					ld			a, e
217+  881F             >				if 0
217+  881F ~           >					add			a, 8
217+  881F             >				else
217+  881F D6 08       >					sub			8
217+  8821             >				endif
217+  8821 5F          >					ld			e, a
217+  8822 3E 4F       >					ld			a, PLAYER_ATTR
217+  8824             >				if 0
217+  8824 ~           >					call		DrawChar
217+  8824 ~           >					ld			a, DRAW_REPLACE
217+  8824 ~           >					jp			SetDrawCharMode
217+  8824             >				else
217+  8824 C3 4E 82    >					jp			DrawChar
217+  8827             >				endif
217+  8827             >
218+  8827              .drawLeft:			DRAWHORZ	1, 0
218+  8827             >
218+  8827 DD 7E 03    >					ld			a, (ix+SPLAYER.time)
218+  882A             >					dup			PLAYER_MOVE_DELAY_BITS
218+  882A 0F          >					rrca
218+  882B             >					edup
218+  882B E6 7F       >					and			(1<<(8-PLAYER_MOVE_DELAY_BITS))-1
218+  882D 3C          >					inc			a
218+  882E             >				if 1
218+  882E ED 44       >					neg
218+  8830             >				endif
218+  8830 5F          >					ld			e, a
218+  8831             >
218+  8831             >				if 0
218+  8831 ~           >					and			3
218+  8831 ~           >					ld			h, 0x01
218+  8831 ~           >					ld			l, a
218+  8831 ~           >					ld			d, 0
218+  8831 ~           >
218+  8831 ~           >					push		af
218+  8831 ~           >
218+  8831 ~           >					push		bc
218+  8831 ~           >					push		de
218+  8831 ~           >					push		hl
218+  8831 ~           >					ld			a, SPHERE_ATTR
218+  8831 ~           >					call		DrawChar
218+  8831 ~           >					pop			hl
218+  8831 ~           >					pop			de
218+  8831 ~           >					pop			bc
218+  8831 ~           >
218+  8831 ~           >					push		bc
218+  8831 ~           >					push		de
218+  8831 ~           >				if left
218+  8831 ~           >					dec			c
218+  8831 ~           >					ld			a, 8
218+  8831 ~           >					add			a, e
218+  8831 ~           >				else
218+  8831 ~           >					inc			c
218+  8831 ~           >					ld			a, e
218+  8831 ~           >					sub			8
218+  8831 ~           >				endif
218+  8831 ~           >					ld			e, a
218+  8831 ~           >					ld			a, SPHERE_ATTR
218+  8831 ~           >					call		DrawChar
218+  8831 ~           >					pop			de
218+  8831 ~           >					pop			bc
218+  8831 ~           >
218+  8831 ~           >					pop			af
218+  8831             >				endif ; shift
218+  8831             >
218+  8831 0F          >					rrca
218+  8832 E6 01       >					and			1
218+  8834             >				if 1
218+  8834 3C          >					inc			a
218+  8835             >				else
218+  8835 ~           >					add			a, 3
218+  8835             >				endif
218+  8835 6F          >					ld			l, a
218+  8836 26 00       >					ld			h, 0
218+  8838 54          >					ld			d, h
218+  8839             >
218+  8839 E5          >					push		hl
218+  883A D5          >					push		de
218+  883B C5          >					push		bc
218+  883C 3E 4F       >					ld			a, PLAYER_ATTR
218+  883E             >				if 1
218+  883E 0C          >					inc			c
218+  883F             >				else
218+  883F ~           >					dec			c
218+  883F             >				endif
218+  883F CD 4E 82    >					call		DrawChar
218+  8842 C1          >					pop			bc
218+  8843 D1          >					pop			de
218+  8844 E1          >					pop			hl
218+  8845             >
218+  8845             >				if 0
218+  8845 ~           >					ld			a, DRAW_OR
218+  8845 ~           >					call		SetDrawCharMode
218+  8845             >				endif
218+  8845             >
218+  8845 7B          >					ld			a, e
218+  8846             >				if 1
218+  8846 C6 08       >					add			a, 8
218+  8848             >				else
218+  8848 ~           >					sub			8
218+  8848             >				endif
218+  8848 5F          >					ld			e, a
218+  8849 3E 4F       >					ld			a, PLAYER_ATTR
218+  884B             >				if 0
218+  884B ~           >					call		DrawChar
218+  884B ~           >					ld			a, DRAW_REPLACE
218+  884B ~           >					jp			SetDrawCharMode
218+  884B             >				else
218+  884B C3 4E 82    >					jp			DrawChar
218+  884E             >				endif
218+  884E             >
219+  884E              .drawDown:			DRAWVERT	0, 0
219+  884E             >
219+  884E DD 7E 03    >					ld			a, (ix+SPLAYER.time)
219+  8851             >					dup			PLAYER_MOVE_DELAY_BITS
219+  8851 0F          >					rrca
219+  8852             >					edup
219+  8852 E6 7F       >					and			(1<<(8-PLAYER_MOVE_DELAY_BITS))-1
219+  8854 3C          >					inc			a
219+  8855             >				if 0
219+  8855 ~           >					neg
219+  8855             >				endif
219+  8855 57          >					ld			d, a
219+  8856 1E 00       >					ld			e, 0
219+  8858             >
219+  8858 E6 03       >					and			3
219+  885A             >
219+  885A             >				if 0
219+  885A ~           >					push		af
219+  885A ~           >					push		de
219+  885A ~           >					push		bc
219+  885A ~           >					ld			h, 1
219+  885A ~           >					ld			l, a
219+  885A ~           >					ld			a, SPHERE_ATTR
219+  885A ~           >					call		DrawChar
219+  885A ~           >					pop			bc
219+  885A ~           >					pop			de
219+  885A ~           >					pop			af
219+  885A             >			 	endif ; shift
219+  885A             >
219+  885A C6 05       >					add			a, 5
219+  885C 6F          >					ld			l, a
219+  885D 63          >					ld			h, e
219+  885E             >
219+  885E 3E 4F       >					ld			a, PLAYER_ATTR
219+  8860             >				if 0
219+  8860 ~           >					inc			b
219+  8860 ~           >					push		de
219+  8860 ~           >					push		bc
219+  8860 ~           >					call		DrawChar
219+  8860 ~           >					pop			bc
219+  8860 ~           >					pop			de
219+  8860 ~           >
219+  8860 ~           >					ld			a, 8
219+  8860 ~           >					add			a, d
219+  8860 ~           >					ld			d, a
219+  8860 ~           >					jp			DrawEmptyByte
219+  8860             >				else
219+  8860 05          >					dec			b
219+  8861 C3 4E 82    >					jp			DrawChar
219+  8864             >				endif
219+  8864             >
220+  8864              .drawUp:			DRAWVERT	1, 0
220+  8864             >
220+  8864 DD 7E 03    >					ld			a, (ix+SPLAYER.time)
220+  8867             >					dup			PLAYER_MOVE_DELAY_BITS
220+  8867 0F          >					rrca
220+  8868             >					edup
220+  8868 E6 7F       >					and			(1<<(8-PLAYER_MOVE_DELAY_BITS))-1
220+  886A 3C          >					inc			a
220+  886B             >				if 1
220+  886B ED 44       >					neg
220+  886D             >				endif
220+  886D 57          >					ld			d, a
220+  886E 1E 00       >					ld			e, 0
220+  8870             >
220+  8870 E6 03       >					and			3
220+  8872             >
220+  8872             >				if 0
220+  8872 ~           >					push		af
220+  8872 ~           >					push		de
220+  8872 ~           >					push		bc
220+  8872 ~           >					ld			h, 1
220+  8872 ~           >					ld			l, a
220+  8872 ~           >					ld			a, SPHERE_ATTR
220+  8872 ~           >					call		DrawChar
220+  8872 ~           >					pop			bc
220+  8872 ~           >					pop			de
220+  8872 ~           >					pop			af
220+  8872             >			 	endif ; shift
220+  8872             >
220+  8872 C6 05       >					add			a, 5
220+  8874 6F          >					ld			l, a
220+  8875 63          >					ld			h, e
220+  8876             >
220+  8876 3E 4F       >					ld			a, PLAYER_ATTR
220+  8878             >				if 1
220+  8878 04          >					inc			b
220+  8879 D5          >					push		de
220+  887A C5          >					push		bc
220+  887B CD 4E 82    >					call		DrawChar
220+  887E C1          >					pop			bc
220+  887F D1          >					pop			de
220+  8880             >
220+  8880 3E 08       >					ld			a, 8
220+  8882 82          >					add			a, d
220+  8883 57          >					ld			d, a
220+  8884 C3 0F 82    >					jp			DrawEmptyByte
220+  8887             >				else
220+  8887 ~           >					dec			b
220+  8887 ~           >					jp			DrawChar
220+  8887             >				endif
220+  8887             >
221+  8887
222+  8887              ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
223+  8887
224+  8887              					macro 		PLAYERGO state, shift
225+  8887 ~
226+  8887 ~            					ld			c, (ix+SPLAYER.x)
227+  8887 ~            					ld			b, (ix+SPLAYER.y)
228+  8887 ~            				if state == PLAYER_GO_UP
229+  8887 ~            					dec			b
230+  8887 ~            				elseif state == PLAYER_GO_DOWN
231+  8887 ~            					inc			b
232+  8887 ~            				elseif state == PLAYER_GO_LEFT
233+  8887 ~            					dec			c
234+  8887 ~            				elseif state == PLAYER_GO_RIGHT
235+  8887 ~            					inc			c
236+  8887 ~            				endif
237+  8887 ~            					call		CheckBlocked
238+  8887 ~            					jr			nz, .tryShift
239+  8887 ~            					ld			a, state
240+  8887 ~            .doGo:			if state == PLAYER_GO_DOWN || state == PLAYER_GO_UP
241+  8887 ~            					ld			(ix+SPLAYER.y), b
242+  8887 ~            				elseif state == PLAYER_GO_LEFT || state == PLAYER_GO_RIGHT
243+  8887 ~            					ld			(ix+SPLAYER.x), c
244+  8887 ~            				endif
245+  8887 ~            					ld			(ix+SPLAYER.state), a
246+  8887 ~            					ld			(ix+SPLAYER.time), 0
247+  8887 ~            					ret
248+  8887 ~            .tryShift:			cp			'O'
249+  8887 ~            					ret			nz
250+  8887 ~            				if state == PLAYER_GO_UP
251+  8887 ~            					dec			b
252+  8887 ~            				elseif state == PLAYER_GO_DOWN
253+  8887 ~            					inc			b
254+  8887 ~            				elseif state == PLAYER_GO_LEFT
255+  8887 ~            					dec			c
256+  8887 ~            				elseif state == PLAYER_GO_RIGHT
257+  8887 ~            					inc			c
258+  8887 ~            				endif
259+  8887 ~            					call		CheckBlocked
260+  8887 ~            					ret			nz
261+  8887 ~            					ld			(hl), 'O'
262+  8887 ~            				if state == PLAYER_GO_UP
263+  8887 ~            					inc			b
264+  8887 ~            					ld			de, 32
265+  8887 ~            					add			hl, de
266+  8887 ~            				elseif state == PLAYER_GO_DOWN
267+  8887 ~            					dec			b
268+  8887 ~            					ld			de, -32
269+  8887 ~            					add			hl, de
270+  8887 ~            				elseif state == PLAYER_GO_LEFT
271+  8887 ~            					inc			c
272+  8887 ~            					inc			hl
273+  8887 ~            				elseif state == PLAYER_GO_RIGHT
274+  8887 ~            					dec			c
275+  8887 ~            					dec			hl
276+  8887 ~            				endif
277+  8887 ~            					ld			(hl), ' '
278+  8887 ~            					ld			a, shift
279+  8887 ~            					jr			.doGo
280+  8887 ~
281+  8887              					endm
282+  8887
283+  8887 DD 6E 02     HandlePlayer:		ld			l, (ix+SPLAYER.state)
284+  888A 26 00        					ld			h, 0
285+  888C 01 91 88     					ld			bc, .jumpTable
286+  888F 09           					add			hl, bc
287+  8890 E9           					jp			(hl)
288+  8891 C3 C0 88     .jumpTable:			jp			.idle
289+  8894 C3 AC 88     					jp			.move
290+  8897 C3 AC 88     					jp			.move
291+  889A C3 AC 88     					jp			.move
292+  889D C3 AC 88     					jp			.move
293+  88A0 C3 AC 88     					jp			.move
294+  88A3 C3 AC 88     					jp			.move
295+  88A6 C3 AC 88     					jp			.move
296+  88A9 C3 AC 88     					jp			.move
297+  88AC
298+  88AC DD 7E 03     .move:				ld			a, (ix+SPLAYER.time)
299+  88AF 3C           					inc			a
300+  88B0 FE 10        					cp			(8<<PLAYER_MOVE_DELAY_BITS)
301+  88B2 28 04        					jr			z, .moveDone
302+  88B4 DD 77 03     					ld			(ix+SPLAYER.time), a
303+  88B7 C9           					ret
304+  88B8 DD 36 02 00  .moveDone:			ld			(ix+SPLAYER.state), PLAYER_IDLE
305+  88BC DD 36 03 00  					ld			(ix+SPLAYER.time), 0
306+  88C0              					;jr			.idle
307+  88C0
308+  88C0 21 CD 83     .idle:				ld			hl, Input.left
309+  88C3 AF           					xor			a
310+  88C4 BE           					cp			(hl)
311+  88C5 28 0E        					jr			z, .goLeft
312+  88C7
313+  88C7 23           					inc			hl
314+  88C8 BE           					cp			(hl)
315+  88C9 28 35        					jr			z, .goRight
316+  88CB
317+  88CB 23           					inc			hl
318+  88CC BE           					cp			(hl)
319+  88CD 28 5C        					jr			z, .goUp
320+  88CF
321+  88CF 23           					inc			hl
322+  88D0 BE           					cp			(hl)
323+  88D1 CA 59 89     					jp			z, .goDown
324+  88D4
325+  88D4 C9           					ret
326+  88D5
327+  88D5              .goLeft:			PLAYERGO	PLAYER_GO_LEFT, PLAYER_SHIFT_LEFT
327+  88D5             >
327+  88D5 DD 4E 00    >					ld			c, (ix+SPLAYER.x)
327+  88D8 DD 46 01    >					ld			b, (ix+SPLAYER.y)
327+  88DB             >				if PLAYER_GO_LEFT == PLAYER_GO_UP
327+  88DB ~           >					dec			b
327+  88DB             >				elseif state == PLAYER_GO_DOWN
327+  88DB ~           >					inc			b
327+  88DB             >				elseif state == PLAYER_GO_LEFT
327+  88DB 0D          >					dec			c
327+  88DC             >				elseif state == PLAYER_GO_RIGHT
327+  88DC ~           >					inc			c
327+  88DC             >				endif
327+  88DC CD B2 86    >					call		CheckBlocked
327+  88DF 20 0D       >					jr			nz, .tryShift
327+  88E1 3E 03       >					ld			a, PLAYER_GO_LEFT
327+  88E3             >.doGo:			if PLAYER_GO_LEFT == PLAYER_GO_DOWN || PLAYER_GO_LEFT == PLAYER_GO_UP
327+  88E3 ~           >					ld			(ix+SPLAYER.y), b
327+  88E3             >				elseif state == PLAYER_GO_LEFT || state == PLAYER_GO_RIGHT
327+  88E3 DD 71 00    >					ld			(ix+SPLAYER.x), c
327+  88E6             >				endif
327+  88E6 DD 77 02    >					ld			(ix+SPLAYER.state), a
327+  88E9 DD 36 03 00 >					ld			(ix+SPLAYER.time), 0
327+  88ED C9          >					ret
327+  88EE FE 4F       >.tryShift:			cp			'O'
327+  88F0 C0          >					ret			nz
327+  88F1             >				if PLAYER_GO_LEFT == PLAYER_GO_UP
327+  88F1 ~           >					dec			b
327+  88F1             >				elseif state == PLAYER_GO_DOWN
327+  88F1 ~           >					inc			b
327+  88F1             >				elseif state == PLAYER_GO_LEFT
327+  88F1 0D          >					dec			c
327+  88F2             >				elseif state == PLAYER_GO_RIGHT
327+  88F2 ~           >					inc			c
327+  88F2             >				endif
327+  88F2 CD B2 86    >					call		CheckBlocked
327+  88F5 C0          >					ret			nz
327+  88F6 36 4F       >					ld			(hl), 'O'
327+  88F8             >				if PLAYER_GO_LEFT == PLAYER_GO_UP
327+  88F8 ~           >					inc			b
327+  88F8 ~           >					ld			de, 32
327+  88F8 ~           >					add			hl, de
327+  88F8             >				elseif state == PLAYER_GO_DOWN
327+  88F8 ~           >					dec			b
327+  88F8 ~           >					ld			de, -32
327+  88F8 ~           >					add			hl, de
327+  88F8             >				elseif state == PLAYER_GO_LEFT
327+  88F8 0C          >					inc			c
327+  88F9 23          >					inc			hl
327+  88FA             >				elseif state == PLAYER_GO_RIGHT
327+  88FA ~           >					dec			c
327+  88FA ~           >					dec			hl
327+  88FA             >				endif
327+  88FA 36 20       >					ld			(hl), ' '
327+  88FC 3E 0F       >					ld			a, PLAYER_SHIFT_LEFT
327+  88FE 18 E3       >					jr			.doGo
327+  8900             >
328+  8900              .goRight:			PLAYERGO	PLAYER_GO_RIGHT, PLAYER_SHIFT_RIGHT
328+  8900             >
328+  8900 DD 4E 00    >					ld			c, (ix+SPLAYER.x)
328+  8903 DD 46 01    >					ld			b, (ix+SPLAYER.y)
328+  8906             >				if PLAYER_GO_RIGHT == PLAYER_GO_UP
328+  8906 ~           >					dec			b
328+  8906             >				elseif state == PLAYER_GO_DOWN
328+  8906 ~           >					inc			b
328+  8906             >				elseif state == PLAYER_GO_LEFT
328+  8906 ~           >					dec			c
328+  8906             >				elseif state == PLAYER_GO_RIGHT
328+  8906 0C          >					inc			c
328+  8907             >				endif
328+  8907 CD B2 86    >					call		CheckBlocked
328+  890A 20 0D       >					jr			nz, .tryShift
328+  890C 3E 06       >					ld			a, PLAYER_GO_RIGHT
328+  890E             >.doGo:			if PLAYER_GO_RIGHT == PLAYER_GO_DOWN || PLAYER_GO_RIGHT == PLAYER_GO_UP
328+  890E ~           >					ld			(ix+SPLAYER.y), b
328+  890E             >				elseif state == PLAYER_GO_LEFT || state == PLAYER_GO_RIGHT
328+  890E DD 71 00    >					ld			(ix+SPLAYER.x), c
328+  8911             >				endif
328+  8911 DD 77 02    >					ld			(ix+SPLAYER.state), a
328+  8914 DD 36 03 00 >					ld			(ix+SPLAYER.time), 0
328+  8918 C9          >					ret
328+  8919 FE 4F       >.tryShift:			cp			'O'
328+  891B C0          >					ret			nz
328+  891C             >				if PLAYER_GO_RIGHT == PLAYER_GO_UP
328+  891C ~           >					dec			b
328+  891C             >				elseif state == PLAYER_GO_DOWN
328+  891C ~           >					inc			b
328+  891C             >				elseif state == PLAYER_GO_LEFT
328+  891C ~           >					dec			c
328+  891C             >				elseif state == PLAYER_GO_RIGHT
328+  891C 0C          >					inc			c
328+  891D             >				endif
328+  891D CD B2 86    >					call		CheckBlocked
328+  8920 C0          >					ret			nz
328+  8921 36 4F       >					ld			(hl), 'O'
328+  8923             >				if PLAYER_GO_RIGHT == PLAYER_GO_UP
328+  8923 ~           >					inc			b
328+  8923 ~           >					ld			de, 32
328+  8923 ~           >					add			hl, de
328+  8923             >				elseif state == PLAYER_GO_DOWN
328+  8923 ~           >					dec			b
328+  8923 ~           >					ld			de, -32
328+  8923 ~           >					add			hl, de
328+  8923             >				elseif state == PLAYER_GO_LEFT
328+  8923 ~           >					inc			c
328+  8923 ~           >					inc			hl
328+  8923             >				elseif state == PLAYER_GO_RIGHT
328+  8923 0D          >					dec			c
328+  8924 2B          >					dec			hl
328+  8925             >				endif
328+  8925 36 20       >					ld			(hl), ' '
328+  8927 3E 12       >					ld			a, PLAYER_SHIFT_RIGHT
328+  8929 18 E3       >					jr			.doGo
328+  892B             >
329+  892B              .goUp:				PLAYERGO	PLAYER_GO_UP, PLAYER_SHIFT_UP
329+  892B             >
329+  892B DD 4E 00    >					ld			c, (ix+SPLAYER.x)
329+  892E DD 46 01    >					ld			b, (ix+SPLAYER.y)
329+  8931             >				if PLAYER_GO_UP == PLAYER_GO_UP
329+  8931 05          >					dec			b
329+  8932             >				elseif state == PLAYER_GO_DOWN
329+  8932 ~           >					inc			b
329+  8932             >				elseif state == PLAYER_GO_LEFT
329+  8932 ~           >					dec			c
329+  8932             >				elseif state == PLAYER_GO_RIGHT
329+  8932 ~           >					inc			c
329+  8932             >				endif
329+  8932 CD B2 86    >					call		CheckBlocked
329+  8935 20 0D       >					jr			nz, .tryShift
329+  8937 3E 09       >					ld			a, PLAYER_GO_UP
329+  8939             >.doGo:			if PLAYER_GO_UP == PLAYER_GO_DOWN || PLAYER_GO_UP == PLAYER_GO_UP
329+  8939 DD 70 01    >					ld			(ix+SPLAYER.y), b
329+  893C             >				elseif state == PLAYER_GO_LEFT || state == PLAYER_GO_RIGHT
329+  893C ~           >					ld			(ix+SPLAYER.x), c
329+  893C             >				endif
329+  893C DD 77 02    >					ld			(ix+SPLAYER.state), a
329+  893F DD 36 03 00 >					ld			(ix+SPLAYER.time), 0
329+  8943 C9          >					ret
329+  8944 FE 4F       >.tryShift:			cp			'O'
329+  8946 C0          >					ret			nz
329+  8947             >				if PLAYER_GO_UP == PLAYER_GO_UP
329+  8947 05          >					dec			b
329+  8948             >				elseif state == PLAYER_GO_DOWN
329+  8948 ~           >					inc			b
329+  8948             >				elseif state == PLAYER_GO_LEFT
329+  8948 ~           >					dec			c
329+  8948             >				elseif state == PLAYER_GO_RIGHT
329+  8948 ~           >					inc			c
329+  8948             >				endif
329+  8948 CD B2 86    >					call		CheckBlocked
329+  894B C0          >					ret			nz
329+  894C 36 4F       >					ld			(hl), 'O'
329+  894E             >				if PLAYER_GO_UP == PLAYER_GO_UP
329+  894E 04          >					inc			b
329+  894F 11 20 00    >					ld			de, 32
329+  8952 19          >					add			hl, de
329+  8953             >				elseif state == PLAYER_GO_DOWN
329+  8953 ~           >					dec			b
329+  8953 ~           >					ld			de, -32
329+  8953 ~           >					add			hl, de
329+  8953             >				elseif state == PLAYER_GO_LEFT
329+  8953 ~           >					inc			c
329+  8953 ~           >					inc			hl
329+  8953             >				elseif state == PLAYER_GO_RIGHT
329+  8953 ~           >					dec			c
329+  8953 ~           >					dec			hl
329+  8953             >				endif
329+  8953 36 20       >					ld			(hl), ' '
329+  8955 3E 15       >					ld			a, PLAYER_SHIFT_UP
329+  8957 18 E0       >					jr			.doGo
329+  8959             >
330+  8959              .goDown:			PLAYERGO	PLAYER_GO_DOWN, PLAYER_SHIFT_DOWN
330+  8959             >
330+  8959 DD 4E 00    >					ld			c, (ix+SPLAYER.x)
330+  895C DD 46 01    >					ld			b, (ix+SPLAYER.y)
330+  895F             >				if PLAYER_GO_DOWN == PLAYER_GO_UP
330+  895F ~           >					dec			b
330+  895F             >				elseif state == PLAYER_GO_DOWN
330+  895F 04          >					inc			b
330+  8960             >				elseif state == PLAYER_GO_LEFT
330+  8960 ~           >					dec			c
330+  8960             >				elseif state == PLAYER_GO_RIGHT
330+  8960 ~           >					inc			c
330+  8960             >				endif
330+  8960 CD B2 86    >					call		CheckBlocked
330+  8963 20 0D       >					jr			nz, .tryShift
330+  8965 3E 0C       >					ld			a, PLAYER_GO_DOWN
330+  8967             >.doGo:			if PLAYER_GO_DOWN == PLAYER_GO_DOWN || PLAYER_GO_DOWN == PLAYER_GO_UP
330+  8967 DD 70 01    >					ld			(ix+SPLAYER.y), b
330+  896A             >				elseif state == PLAYER_GO_LEFT || state == PLAYER_GO_RIGHT
330+  896A ~           >					ld			(ix+SPLAYER.x), c
330+  896A             >				endif
330+  896A DD 77 02    >					ld			(ix+SPLAYER.state), a
330+  896D DD 36 03 00 >					ld			(ix+SPLAYER.time), 0
330+  8971 C9          >					ret
330+  8972 FE 4F       >.tryShift:			cp			'O'
330+  8974 C0          >					ret			nz
330+  8975             >				if PLAYER_GO_DOWN == PLAYER_GO_UP
330+  8975 ~           >					dec			b
330+  8975             >				elseif state == PLAYER_GO_DOWN
330+  8975 04          >					inc			b
330+  8976             >				elseif state == PLAYER_GO_LEFT
330+  8976 ~           >					dec			c
330+  8976             >				elseif state == PLAYER_GO_RIGHT
330+  8976 ~           >					inc			c
330+  8976             >				endif
330+  8976 CD B2 86    >					call		CheckBlocked
330+  8979 C0          >					ret			nz
330+  897A 36 4F       >					ld			(hl), 'O'
330+  897C             >				if PLAYER_GO_DOWN == PLAYER_GO_UP
330+  897C ~           >					inc			b
330+  897C ~           >					ld			de, 32
330+  897C ~           >					add			hl, de
330+  897C             >				elseif state == PLAYER_GO_DOWN
330+  897C 05          >					dec			b
330+  897D 11 E0 FF    >					ld			de, -32
330+  8980 19          >					add			hl, de
330+  8981             >				elseif state == PLAYER_GO_LEFT
330+  8981 ~           >					inc			c
330+  8981 ~           >					inc			hl
330+  8981             >				elseif state == PLAYER_GO_RIGHT
330+  8981 ~           >					dec			c
330+  8981 ~           >					dec			hl
330+  8981             >				endif
330+  8981 36 20       >					ld			(hl), ' '
330+  8983 3E 18       >					ld			a, PLAYER_SHIFT_DOWN
330+  8985 18 E0       >					jr			.doGo
330+  8987             >
331+  8987
# file closed: player.asm
 46   8987
 47   8987 00 00 00...  					ds			0xa000-$
 48   A000              					org			0xa000
 49   A000
 50   A000              gfx:				incbin		"gfx/gfx.scr"
 51   BB00
 52   BB00              					savesna 	"game.sna", start
 53   BB00              					SLDOPT 		COMMENT WPMEM, LOGPOINT, ASSERTION
 54   BB00
# file closed: game.asm
