# file opened: game.asm
  1   0000
  2   0000              					device 		zxspectrum48
  3   0000
  4   0000              stack_top:
  5   0000
  6   0000              					include		"irq.asm"
# file opened: irq.asm
  1+  0000
  2+  0000              					org			8000h
  3+  8000
  4+  8000              INTERRUPT = 81h
  5+  8000
  6+  8000              irq_vectors:		dup			257
  7+  8000 81          >					db			INTERRUPT
  7+  8001 81          >					db			INTERRUPT
  7+  8002 81          >					db			INTERRUPT
  7+  8003 81          >					db			INTERRUPT
  7+  8004 81          >					db			INTERRUPT
  7+  8005 81          >					db			INTERRUPT
  7+  8006 81          >					db			INTERRUPT
  7+  8007 81          >					db			INTERRUPT
  7+  8008 81          >					db			INTERRUPT
  7+  8009 81          >					db			INTERRUPT
  7+  800A 81          >					db			INTERRUPT
  7+  800B 81          >					db			INTERRUPT
  7+  800C 81          >					db			INTERRUPT
  7+  800D 81          >					db			INTERRUPT
  7+  800E 81          >					db			INTERRUPT
  7+  800F 81          >					db			INTERRUPT
  7+  8010 81          >					db			INTERRUPT
  7+  8011 81          >					db			INTERRUPT
  7+  8012 81          >					db			INTERRUPT
  7+  8013 81          >					db			INTERRUPT
  7+  8014 81          >					db			INTERRUPT
  7+  8015 81          >					db			INTERRUPT
  7+  8016 81          >					db			INTERRUPT
  7+  8017 81          >					db			INTERRUPT
  7+  8018 81          >					db			INTERRUPT
  7+  8019 81          >					db			INTERRUPT
  7+  801A 81          >					db			INTERRUPT
  7+  801B 81          >					db			INTERRUPT
  7+  801C 81          >					db			INTERRUPT
  7+  801D 81          >					db			INTERRUPT
  7+  801E 81          >					db			INTERRUPT
  7+  801F 81          >					db			INTERRUPT
  7+  8020 81          >					db			INTERRUPT
  7+  8021 81          >					db			INTERRUPT
  7+  8022 81          >					db			INTERRUPT
  7+  8023 81          >					db			INTERRUPT
  7+  8024 81          >					db			INTERRUPT
  7+  8025 81          >					db			INTERRUPT
  7+  8026 81          >					db			INTERRUPT
  7+  8027 81          >					db			INTERRUPT
  7+  8028 81          >					db			INTERRUPT
  7+  8029 81          >					db			INTERRUPT
  7+  802A 81          >					db			INTERRUPT
  7+  802B 81          >					db			INTERRUPT
  7+  802C 81          >					db			INTERRUPT
  7+  802D 81          >					db			INTERRUPT
  7+  802E 81          >					db			INTERRUPT
  7+  802F 81          >					db			INTERRUPT
  7+  8030 81          >					db			INTERRUPT
  7+  8031 81          >					db			INTERRUPT
  7+  8032 81          >					db			INTERRUPT
  7+  8033 81          >					db			INTERRUPT
  7+  8034 81          >					db			INTERRUPT
  7+  8035 81          >					db			INTERRUPT
  7+  8036 81          >					db			INTERRUPT
  7+  8037 81          >					db			INTERRUPT
  7+  8038 81          >					db			INTERRUPT
  7+  8039 81          >					db			INTERRUPT
  7+  803A 81          >					db			INTERRUPT
  7+  803B 81          >					db			INTERRUPT
  7+  803C 81          >					db			INTERRUPT
  7+  803D 81          >					db			INTERRUPT
  7+  803E 81          >					db			INTERRUPT
  7+  803F 81          >					db			INTERRUPT
  7+  8040 81          >					db			INTERRUPT
  7+  8041 81          >					db			INTERRUPT
  7+  8042 81          >					db			INTERRUPT
  7+  8043 81          >					db			INTERRUPT
  7+  8044 81          >					db			INTERRUPT
  7+  8045 81          >					db			INTERRUPT
  7+  8046 81          >					db			INTERRUPT
  7+  8047 81          >					db			INTERRUPT
  7+  8048 81          >					db			INTERRUPT
  7+  8049 81          >					db			INTERRUPT
  7+  804A 81          >					db			INTERRUPT
  7+  804B 81          >					db			INTERRUPT
  7+  804C 81          >					db			INTERRUPT
  7+  804D 81          >					db			INTERRUPT
  7+  804E 81          >					db			INTERRUPT
  7+  804F 81          >					db			INTERRUPT
  7+  8050 81          >					db			INTERRUPT
  7+  8051 81          >					db			INTERRUPT
  7+  8052 81          >					db			INTERRUPT
  7+  8053 81          >					db			INTERRUPT
  7+  8054 81          >					db			INTERRUPT
  7+  8055 81          >					db			INTERRUPT
  7+  8056 81          >					db			INTERRUPT
  7+  8057 81          >					db			INTERRUPT
  7+  8058 81          >					db			INTERRUPT
  7+  8059 81          >					db			INTERRUPT
  7+  805A 81          >					db			INTERRUPT
  7+  805B 81          >					db			INTERRUPT
  7+  805C 81          >					db			INTERRUPT
  7+  805D 81          >					db			INTERRUPT
  7+  805E 81          >					db			INTERRUPT
  7+  805F 81          >					db			INTERRUPT
  7+  8060 81          >					db			INTERRUPT
  7+  8061 81          >					db			INTERRUPT
  7+  8062 81          >					db			INTERRUPT
  7+  8063 81          >					db			INTERRUPT
  7+  8064 81          >					db			INTERRUPT
  7+  8065 81          >					db			INTERRUPT
  7+  8066 81          >					db			INTERRUPT
  7+  8067 81          >					db			INTERRUPT
  7+  8068 81          >					db			INTERRUPT
  7+  8069 81          >					db			INTERRUPT
  7+  806A 81          >					db			INTERRUPT
  7+  806B 81          >					db			INTERRUPT
  7+  806C 81          >					db			INTERRUPT
  7+  806D 81          >					db			INTERRUPT
  7+  806E 81          >					db			INTERRUPT
  7+  806F 81          >					db			INTERRUPT
  7+  8070 81          >					db			INTERRUPT
  7+  8071 81          >					db			INTERRUPT
  7+  8072 81          >					db			INTERRUPT
  7+  8073 81          >					db			INTERRUPT
  7+  8074 81          >					db			INTERRUPT
  7+  8075 81          >					db			INTERRUPT
  7+  8076 81          >					db			INTERRUPT
  7+  8077 81          >					db			INTERRUPT
  7+  8078 81          >					db			INTERRUPT
  7+  8079 81          >					db			INTERRUPT
  7+  807A 81          >					db			INTERRUPT
  7+  807B 81          >					db			INTERRUPT
  7+  807C 81          >					db			INTERRUPT
  7+  807D 81          >					db			INTERRUPT
  7+  807E 81          >					db			INTERRUPT
  7+  807F 81          >					db			INTERRUPT
  7+  8080 81          >					db			INTERRUPT
  7+  8081 81          >					db			INTERRUPT
  7+  8082 81          >					db			INTERRUPT
  7+  8083 81          >					db			INTERRUPT
  7+  8084 81          >					db			INTERRUPT
  7+  8085 81          >					db			INTERRUPT
  7+  8086 81          >					db			INTERRUPT
  7+  8087 81          >					db			INTERRUPT
  7+  8088 81          >					db			INTERRUPT
  7+  8089 81          >					db			INTERRUPT
  7+  808A 81          >					db			INTERRUPT
  7+  808B 81          >					db			INTERRUPT
  7+  808C 81          >					db			INTERRUPT
  7+  808D 81          >					db			INTERRUPT
  7+  808E 81          >					db			INTERRUPT
  7+  808F 81          >					db			INTERRUPT
  7+  8090 81          >					db			INTERRUPT
  7+  8091 81          >					db			INTERRUPT
  7+  8092 81          >					db			INTERRUPT
  7+  8093 81          >					db			INTERRUPT
  7+  8094 81          >					db			INTERRUPT
  7+  8095 81          >					db			INTERRUPT
  7+  8096 81          >					db			INTERRUPT
  7+  8097 81          >					db			INTERRUPT
  7+  8098 81          >					db			INTERRUPT
  7+  8099 81          >					db			INTERRUPT
  7+  809A 81          >					db			INTERRUPT
  7+  809B 81          >					db			INTERRUPT
  7+  809C 81          >					db			INTERRUPT
  7+  809D 81          >					db			INTERRUPT
  7+  809E 81          >					db			INTERRUPT
  7+  809F 81          >					db			INTERRUPT
  7+  80A0 81          >					db			INTERRUPT
  7+  80A1 81          >					db			INTERRUPT
  7+  80A2 81          >					db			INTERRUPT
  7+  80A3 81          >					db			INTERRUPT
  7+  80A4 81          >					db			INTERRUPT
  7+  80A5 81          >					db			INTERRUPT
  7+  80A6 81          >					db			INTERRUPT
  7+  80A7 81          >					db			INTERRUPT
  7+  80A8 81          >					db			INTERRUPT
  7+  80A9 81          >					db			INTERRUPT
  7+  80AA 81          >					db			INTERRUPT
  7+  80AB 81          >					db			INTERRUPT
  7+  80AC 81          >					db			INTERRUPT
  7+  80AD 81          >					db			INTERRUPT
  7+  80AE 81          >					db			INTERRUPT
  7+  80AF 81          >					db			INTERRUPT
  7+  80B0 81          >					db			INTERRUPT
  7+  80B1 81          >					db			INTERRUPT
  7+  80B2 81          >					db			INTERRUPT
  7+  80B3 81          >					db			INTERRUPT
  7+  80B4 81          >					db			INTERRUPT
  7+  80B5 81          >					db			INTERRUPT
  7+  80B6 81          >					db			INTERRUPT
  7+  80B7 81          >					db			INTERRUPT
  7+  80B8 81          >					db			INTERRUPT
  7+  80B9 81          >					db			INTERRUPT
  7+  80BA 81          >					db			INTERRUPT
  7+  80BB 81          >					db			INTERRUPT
  7+  80BC 81          >					db			INTERRUPT
  7+  80BD 81          >					db			INTERRUPT
  7+  80BE 81          >					db			INTERRUPT
  7+  80BF 81          >					db			INTERRUPT
  7+  80C0 81          >					db			INTERRUPT
  7+  80C1 81          >					db			INTERRUPT
  7+  80C2 81          >					db			INTERRUPT
  7+  80C3 81          >					db			INTERRUPT
  7+  80C4 81          >					db			INTERRUPT
  7+  80C5 81          >					db			INTERRUPT
  7+  80C6 81          >					db			INTERRUPT
  7+  80C7 81          >					db			INTERRUPT
  7+  80C8 81          >					db			INTERRUPT
  7+  80C9 81          >					db			INTERRUPT
  7+  80CA 81          >					db			INTERRUPT
  7+  80CB 81          >					db			INTERRUPT
  7+  80CC 81          >					db			INTERRUPT
  7+  80CD 81          >					db			INTERRUPT
  7+  80CE 81          >					db			INTERRUPT
  7+  80CF 81          >					db			INTERRUPT
  7+  80D0 81          >					db			INTERRUPT
  7+  80D1 81          >					db			INTERRUPT
  7+  80D2 81          >					db			INTERRUPT
  7+  80D3 81          >					db			INTERRUPT
  7+  80D4 81          >					db			INTERRUPT
  7+  80D5 81          >					db			INTERRUPT
  7+  80D6 81          >					db			INTERRUPT
  7+  80D7 81          >					db			INTERRUPT
  7+  80D8 81          >					db			INTERRUPT
  7+  80D9 81          >					db			INTERRUPT
  7+  80DA 81          >					db			INTERRUPT
  7+  80DB 81          >					db			INTERRUPT
  7+  80DC 81          >					db			INTERRUPT
  7+  80DD 81          >					db			INTERRUPT
  7+  80DE 81          >					db			INTERRUPT
  7+  80DF 81          >					db			INTERRUPT
  7+  80E0 81          >					db			INTERRUPT
  7+  80E1 81          >					db			INTERRUPT
  7+  80E2 81          >					db			INTERRUPT
  7+  80E3 81          >					db			INTERRUPT
  7+  80E4 81          >					db			INTERRUPT
  7+  80E5 81          >					db			INTERRUPT
  7+  80E6 81          >					db			INTERRUPT
  7+  80E7 81          >					db			INTERRUPT
  7+  80E8 81          >					db			INTERRUPT
  7+  80E9 81          >					db			INTERRUPT
  7+  80EA 81          >					db			INTERRUPT
  7+  80EB 81          >					db			INTERRUPT
  7+  80EC 81          >					db			INTERRUPT
  7+  80ED 81          >					db			INTERRUPT
  7+  80EE 81          >					db			INTERRUPT
  7+  80EF 81          >					db			INTERRUPT
  7+  80F0 81          >					db			INTERRUPT
  7+  80F1 81          >					db			INTERRUPT
  7+  80F2 81          >					db			INTERRUPT
  7+  80F3 81          >					db			INTERRUPT
  7+  80F4 81          >					db			INTERRUPT
  7+  80F5 81          >					db			INTERRUPT
  7+  80F6 81          >					db			INTERRUPT
  7+  80F7 81          >					db			INTERRUPT
  7+  80F8 81          >					db			INTERRUPT
  7+  80F9 81          >					db			INTERRUPT
  7+  80FA 81          >					db			INTERRUPT
  7+  80FB 81          >					db			INTERRUPT
  7+  80FC 81          >					db			INTERRUPT
  7+  80FD 81          >					db			INTERRUPT
  7+  80FE 81          >					db			INTERRUPT
  7+  80FF 81          >					db			INTERRUPT
  7+  8100 81          >					db			INTERRUPT
  8+  8101              					edup
  9+  8101
 10+  8101 00 00 00...  					ds			(INTERRUPT*256+INTERRUPT)-$
 11+  8181
 12+  8181              					org			(INTERRUPT*256+INTERRUPT)
 13+  8181
 14+  8181 F5           interrupt:			push		af
 15+  8182 C5           					push		bc
 16+  8183 D5           					push		de
 17+  8184 E5           					push		hl
 18+  8185 08           					ex			af, af'
 19+  8186 D9           					exx
 20+  8187 F5           					push		af
 21+  8188 C5           					push		bc
 22+  8189 D5           					push		de
 23+  818A E5           					push		hl
 24+  818B DD E5        					push		ix
 25+  818D FD E5        					push		iy
 26+  818F
 27+  818F 21 DE 81     					ld			hl, FramesPending
 28+  8192 34           					inc			(hl)
 29+  8193
 30+  8193              					; рисуем спрайты
 31+  8193
 32+  8193 DD 21 DD 86  					ld			ix, player1
 33+  8197 CD E6 86     					call		DrawPlayer
 34+  819A
 35+  819A              					; готово
 36+  819A
 37+  819A FD E1        					pop			iy
 38+  819C DD E1        					pop			ix
 39+  819E E1           					pop			hl
 40+  819F D1           					pop			de
 41+  81A0 C1           					pop			bc
 42+  81A1 F1           					pop			af
 43+  81A2 08           					ex			af, af'
 44+  81A3 D9           					exx
 45+  81A4 E1           					pop			hl
 46+  81A5 D1           					pop			de
 47+  81A6 C1           					pop			bc
 48+  81A7 F1           					pop			af
 49+  81A8 FB           					ei
 50+  81A9 C9           					ret
 51+  81AA
# file closed: irq.asm
  7   81AA
  8   81AA F3           start:				di
  9   81AB 31 00 00     					ld			sp, stack_top
 10   81AE 3E 80        					ld			a, 80h
 11   81B0 ED 47        					ld			i, a
 12   81B2 ED 5E        					im			2
 13   81B4 FB           					ei
 14   81B5
 15   81B5 3E 00        					ld			a, 00h
 16   81B7 CD DF 81     					call		ClearScreen
 17   81BA
 18   81BA CD 52 86     					call		InitLevel
 19   81BD CD 7B 86     					call		DrawLevel
 20   81C0
 21   81C0 DD 21 DD 86  					ld			ix, player1
 22   81C4 CD E1 86     					call		InitPlayer
 23   81C7
 24   81C7 21 DE 81     .mainLoop:			ld			hl, FramesPending
 25   81CA AF           					xor			a
 26   81CB BE           					cp			(hl)
 27   81CC 28 0D        					jr			z, .halt
 28   81CE 35           					dec			(hl)
 29   81CF
 30   81CF CD 9D 83     					call		ReadInput
 31   81D2
 32   81D2 DD 21 DD 86  					ld			ix, player1
 33   81D6 CD 9B 88     					call		HandlePlayer
 34   81D9
 35   81D9 18 EC        					jr			.mainLoop
 36   81DB
 37   81DB 76           .halt:				halt
 38   81DC 18 E9        					jr			.mainLoop
 39   81DE
 40   81DE 00           FramesPending:		db			0
 41   81DF
 42   81DF              					include		"draw.asm"
# file opened: draw.asm
  1+  81DF
  2+  81DF              				; Input:
  3+  81DF              				;   A = attribute
  4+  81DF
  5+  81DF              ClearScreen:	; очищаем пиксели
  6+  81DF 21 00 40     				ld		hl, 4000h
  7+  81E2 5D           				ld      e, l
  8+  81E3 54           				ld		d, h
  9+  81E4 36 00        				ld		(hl), 0
 10+  81E6 13           				inc		de
 11+  81E7 01 00 18     				ld		bc, 1800h
 12+  81EA ED B0        				ldir
 13+  81EC              				; очищаем атрибуты
 14+  81EC 77           				ld		(hl), a
 15+  81ED 01 FF 02     				ld		bc, 300h-1
 16+  81F0 ED B0        				ldir
 17+  81F2 C9           				ret
 18+  81F3
 19+  81F3                              ; Input:
 20+  81F3                              ;   C = X
 21+  81F3                              ;   B = Y (знакоместо)
 22+  81F3                              ;   IYH = старший байт адреса
 23+  81F3                              ; Output:
 24+  81F3                              ;   DE => screen addr
 25+  81F3
 26+  81F3              CalcScreenAddr: ; Преобразуем координату Y в пикселях в значение в знакоместах
 27+  81F3 78                           ld		a, b
 28+  81F4 17                           rla
 29+  81F5 17                           rla
 30+  81F6 17                           rla
 31+  81F7 E6 F8                        and		0xf8
 32+  81F9              ; альтернативная точка входа, A = Y (пиксели)
 33+  81F9              CalcScreenAddrPix:
 34+  81F9 47                           ld		b, a
 35+  81FA                              ; Расчитываем адрес на экране
 36+  81FA 17                           rla                                 ; A = ? |Y5|Y4|Y3| ?| ?| ?| ?
 37+  81FB 17                           rla                                 ; A = Y5|Y4|Y3| ?| ?| ?| ?| ?
 38+  81FC E6 E0                        and     0xe0            ; 1110 0000 ; A = Y5|Y4|Y3| 0| 0| 0| 0| 0
 39+  81FE B1                           or      c               ;             A = Y5|Y4|Y3|X4|X3|X2|X1|X0
 40+  81FF 5F                           ld      e, a
 41+  8200 78                           ld      a, b
 42+  8201 1F                           rra
 43+  8202 1F                           rra
 44+  8203 1F                           rra                                 ; A =  ?| ?| ?|Y7|Y6| ?| ?| ?
 45+  8204 E6 18                        and     0x18                        ; A =  0| 0| 0|Y7|Y6| 0| 0| 0
 46+  8206 57                           ld      d, a
 47+  8207 78                           ld      a, b
 48+  8208 E6 07                        and     0x07                        ; A =  0| 0| 0| 0| 0|Y2|Y1|Y0
 49+  820A B2                           or      d                           ; A =  0| 0| 0|Y7|Y6|Y2|Y1|Y0
 50+  820B FD B4                        or      iyh                         ; A =  0| 1| 0|Y7|Y6|Y2|Y1|Y0
 51+  820D 57                           ld      d, a
 52+  820E C9                           ret
 53+  820F
 54+  820F                              ; Input:
 55+  820F                              ;   C = X (знакоместо)
 56+  820F                              ;   B = Y (знакоместо)
 57+  820F                              ;   D = дополнительный сдвиг по Y (-7..7)
 58+  820F
 59+  820F              DrawEmptyByte:	; Расчитываем адрес назначения
 60+  820F FD 26 40                     ld		iyh, 0x40
 61+  8212 78                           ld		a, b
 62+  8213 87                           add		a, a		; *2
 63+  8214 87                           add		a, a		; *4
 64+  8215 87                           add		a, a		; *8
 65+  8216 82                           add		a, d
 66+  8217 CD F9 81         			call    CalcScreenAddrPix
 67+  821A                  			; Записываем нулевой байт
 68+  821A AF               			xor		a
 69+  821B 12               			ld		(de), a
 70+  821C C9               			ret
 71+  821D
 72+  821D              DRAW_REPLACE 	equ		0			; nop
 73+  821D              DRAW_OR			equ		0xB6		; or (hl)
 74+  821D
 75+  821D                              ; Input:
 76+  821D                              ;   A = mode (DRAW_OR или DRAW_REPLACE)
 77+  821D
 78+  821D 32 89 82     SetDrawCharMode:ld		(DrawChar.hotPatch1), a
 79+  8220 32 97 82     				ld		(DrawChar.hotPatch2), a
 80+  8223 32 A7 82     				ld		(DrawChar.hotPatch3), a
 81+  8226 32 B8 82     				ld		(DrawChar.hotPatch4), a
 82+  8229 32 CA 82     				ld		(DrawChar.hotPatch5), a
 83+  822C 32 DB 82     				ld		(DrawChar.hotPatch6), a
 84+  822F 32 EB 82     				ld		(DrawChar.hotPatch7), a
 85+  8232 32 F9 82     				ld		(DrawChar.hotPatch8), a
 86+  8235 32 04 83     				ld		(DrawChar.hotPatch9), a
 87+  8238 32 11 83     				ld		(DrawChar.hotPatch10), a
 88+  823B 32 20 83     				ld		(DrawChar.hotPatch11), a
 89+  823E 32 30 83     				ld		(DrawChar.hotPatch12), a
 90+  8241 32 41 83     				ld		(DrawChar.hotPatch13), a
 91+  8244 32 51 83     				ld		(DrawChar.hotPatch14), a
 92+  8247 32 60 83     				ld		(DrawChar.hotPatch15), a
 93+  824A 32 6E 83     				ld		(DrawChar.hotPatch16), a
 94+  824D C9           				ret
 95+  824E
 96+  824E                              ; Input:
 97+  824E                              ;	A = атрибут
 98+  824E                              ;   E = дополнительный сдвиг по X (-7..7)
 99+  824E                              ;   D = дополнительный сдвиг по Y (-7..7)
100+  824E                              ;   L = X спрайта (знакоместо)
101+  824E                              ;   H = Y спрайта (знакоместо)
102+  824E                              ;   C = X (знакоместо)
103+  824E                              ;   B = Y (знакоместо)
104+  824E
105+  824E              DrawChar:    	; Сохраняем А
106+  824E 08                           ex      af, af'
107+  824F                              ; Патчим код
108+  824F 7B                           ld		a, e
109+  8250 32 6E 82                     ld		(.hotPatch+2), a
110+  8253              				; Расчитываем адрес назначения
111+  8253 FD 26 40                     ld		iyh, 0x40
112+  8256 78                           ld		a, b
113+  8257 87                           add		a, a		; *2
114+  8258 87                           add		a, a		; *4
115+  8259 87                           add		a, a		; *8
116+  825A 82                           add		a, d
117+  825B CD F9 81         			call    CalcScreenAddrPix
118+  825E D5                           push	de
119+  825F                              ; Преобразуем координату Y спрайта в адрес в SCR
120+  825F 44                           ld		b, h
121+  8260 4D                           ld		c, l
122+  8261 EB                           ex		de, hl		; сохраню DE в HL
123+  8262                              ; Расчитываем адрес спрайта
124+  8262 FD 26 A0                     ld		iyh, high gfx
125+  8265 CD F3 81                     call	CalcScreenAddr
126+  8268
127+  8268 FD 21 7F 82  				ld		iy, .table
128+  826C FD 4E 00     .hotPatch:		ld		c, (iy+0)
129+  826F 06 00        				ld		b, 0
130+  8271 FD 09        				add		iy, bc
131+  8273 06 08                        ld      b, 8		; счетчик для цикла
132+  8275 FD E9        				jp		(iy)
133+  8277
134+  8277 09           				db		.empty-.table
135+  8278 14           				db		.shiftM7-.table
136+  8279 23           				db		.shiftM6-.table
137+  827A 33           				db		.shiftM5-.table
138+  827B 44           				db		.shiftM4-.table
139+  827C 56           				db		.shiftM3-.table
140+  827D 67           				db		.shiftM2-.table
141+  827E 77           				db		.shiftM1-.table
142+  827F 84           .table:			db		.noShift-.table
143+  8280 8F           				db		.shift1-.table
144+  8281 9C           				db		.shift2-.table
145+  8282 AB           				db		.shift3-.table
146+  8283 BB           				db		.shift4-.table
147+  8284 CC           				db		.shift5-.table
148+  8285 DC           				db		.shift6-.table
149+  8286 EB           				db		.shift7-.table
150+  8287 09           				db		.empty-.table
151+  8288
152+  8288 AF           .empty:       	xor		a
153+  8289 00           .hotPatch1:		nop
154+  828A 77           				ld      (hl), a
155+  828B CD 8E 83                     call	DownHL
156+  828E 10 F8                        djnz    .empty
157+  8290 C3 76 83                     jp		.charDone
158+  8293
159+  8293 1A           .shiftM7:       ld      a, (de)
160+  8294 0F           				rrca
161+  8295 E6 80        				and		0x80
162+  8297 00           .hotPatch2:		nop
163+  8298 77                           ld      (hl), a
164+  8299 14                           inc     d
165+  829A CD 8E 83                     call	DownHL
166+  829D 10 F4                        djnz    .shiftM7
167+  829F C3 76 83                     jp		.charDone
168+  82A2
169+  82A2 1A           .shiftM6:       ld      a, (de)
170+  82A3 0F           				rrca
171+  82A4 0F           				rrca
172+  82A5 E6 C0        				and		0xc0
173+  82A7 00           .hotPatch3:		nop
174+  82A8 77                           ld      (hl), a
175+  82A9 14                           inc     d
176+  82AA CD 8E 83                     call	DownHL
177+  82AD 10 F3                        djnz    .shiftM6
178+  82AF C3 76 83                     jp		.charDone
179+  82B2
180+  82B2 1A           .shiftM5:       ld      a, (de)
181+  82B3              				dup		3
182+  82B3 0F          >				rrca
182+  82B4 0F          >				rrca
182+  82B5 0F          >				rrca
183+  82B6              				edup
184+  82B6 E6 E0        				and		0xe0
185+  82B8 00           .hotPatch4:		nop
186+  82B9 77                           ld      (hl), a
187+  82BA 14                           inc     d
188+  82BB CD 8E 83                     call	DownHL
189+  82BE 10 F2                        djnz    .shiftM5
190+  82C0 C3 76 83                     jp		.charDone
191+  82C3
192+  82C3 1A           .shiftM4:       ld      a, (de)
193+  82C4              				dup		4
194+  82C4 07          >				rlca
194+  82C5 07          >				rlca
194+  82C6 07          >				rlca
194+  82C7 07          >				rlca
195+  82C8              				edup
196+  82C8 E6 F0        				and		0xf0
197+  82CA 00           .hotPatch5:		nop
198+  82CB 77                           ld      (hl), a
199+  82CC 14                           inc     d
200+  82CD CD 8E 83                     call	DownHL
201+  82D0 10 F1                        djnz    .shiftM4
202+  82D2 C3 76 83                     jp		.charDone
203+  82D5
204+  82D5 1A           .shiftM3:       ld      a, (de)
205+  82D6              				dup		3
206+  82D6 07          >				rlca
206+  82D7 07          >				rlca
206+  82D8 07          >				rlca
207+  82D9              				edup
208+  82D9 E6 F8        				and		0xf8
209+  82DB 00           .hotPatch6:		nop
210+  82DC 77                           ld      (hl), a
211+  82DD 14                           inc     d
212+  82DE CD 8E 83                     call	DownHL
213+  82E1 10 F2                        djnz    .shiftM3
214+  82E3 C3 76 83                     jp		.charDone
215+  82E6
216+  82E6 1A           .shiftM2:       ld      a, (de)
217+  82E7 07           				rlca
218+  82E8 07           				rlca
219+  82E9 E6 FC        				and		0xfc
220+  82EB 00           .hotPatch7:		nop
221+  82EC 77                           ld      (hl), a
222+  82ED 14                           inc     d
223+  82EE CD 8E 83                     call	DownHL
224+  82F1 10 F3                        djnz    .shiftM2
225+  82F3 C3 76 83                     jp		.charDone
226+  82F6
227+  82F6 1A           .shiftM1:       ld      a, (de)
228+  82F7 CB 27        				sla		a
229+  82F9 00           .hotPatch8:		nop
230+  82FA 77                           ld      (hl), a
231+  82FB 14                           inc     d
232+  82FC CD 8E 83                     call	DownHL
233+  82FF 10 F5                        djnz    .shiftM1
234+  8301 18 73                        jr		.charDone
235+  8303
236+  8303 1A           .noShift:       ld      a, (de)
237+  8304 00           .hotPatch9:		nop
238+  8305 77                           ld      (hl), a
239+  8306 14                           inc     d
240+  8307 CD 8E 83                     call	DownHL
241+  830A 10 F7                        djnz    .noShift
242+  830C 18 68                        jr		.charDone
243+  830E
244+  830E 1A           .shift1:       	ld      a, (de)
245+  830F CB 3F        				srl		a
246+  8311 00           .hotPatch10:	nop
247+  8312 77                           ld      (hl), a
248+  8313 14                           inc     d
249+  8314 CD 8E 83                     call	DownHL
250+  8317 10 F5                        djnz    .shift1
251+  8319 18 5B                        jr		.charDone
252+  831B
253+  831B 1A           .shift2:       	ld      a, (de)
254+  831C 0F           				rrca
255+  831D 0F           				rrca
256+  831E E6 3F        				and		0x3f
257+  8320 00           .hotPatch11:	nop
258+  8321 77                           ld      (hl), a
259+  8322 14                           inc     d
260+  8323 CD 8E 83                     call	DownHL
261+  8326 10 F3                        djnz    .shift2
262+  8328 18 4C                        jr		.charDone
263+  832A
264+  832A 1A           .shift3:       	ld      a, (de)
265+  832B              				dup		3
266+  832B 0F          >				rrca
266+  832C 0F          >				rrca
266+  832D 0F          >				rrca
267+  832E              				edup
268+  832E E6 1F        				and		0x1f
269+  8330 00           .hotPatch12:	nop
270+  8331 77                           ld      (hl), a
271+  8332 14                           inc     d
272+  8333 CD 8E 83                     call	DownHL
273+  8336 10 F2                        djnz    .shift3
274+  8338 18 3C                        jr		.charDone
275+  833A
276+  833A 1A           .shift4:       	ld      a, (de)
277+  833B              				dup		4
278+  833B 0F          >				rrca
278+  833C 0F          >				rrca
278+  833D 0F          >				rrca
278+  833E 0F          >				rrca
279+  833F              				edup
280+  833F E6 0F        				and		0x0f
281+  8341 00           .hotPatch13:	nop
282+  8342 77                           ld      (hl), a
283+  8343 14                           inc     d
284+  8344 CD 8E 83                     call	DownHL
285+  8347 10 F1                        djnz    .shift4
286+  8349 18 2B                        jr		.charDone
287+  834B
288+  834B 1A           .shift5:       	ld      a, (de)
289+  834C              				dup		3
290+  834C 07          >				rlca
290+  834D 07          >				rlca
290+  834E 07          >				rlca
291+  834F              				edup
292+  834F E6 07        				and		0x07
293+  8351 00           .hotPatch14:	nop
294+  8352 77                           ld      (hl), a
295+  8353 14                           inc     d
296+  8354 CD 8E 83                     call	DownHL
297+  8357 10 F2                        djnz    .shift5
298+  8359 18 1B                        jr		.charDone
299+  835B
300+  835B 1A           .shift6:       	ld      a, (de)
301+  835C              				dup		2
302+  835C 07          >				rlca
302+  835D 07          >				rlca
303+  835E              				edup
304+  835E E6 03        				and		0x03
305+  8360 00           .hotPatch15:	nop
306+  8361 77                           ld      (hl), a
307+  8362 14                           inc     d
308+  8363 CD 8E 83                     call	DownHL
309+  8366 10 F3                        djnz    .shift6
310+  8368 18 0C                        jr		.charDone
311+  836A
312+  836A 1A           .shift7:       	ld      a, (de)
313+  836B 07           				rlca
314+  836C E6 01        				and		0x01
315+  836E 00           .hotPatch16:	nop
316+  836F 77                           ld      (hl), a
317+  8370 14                           inc     d
318+  8371 CD 8E 83                     call	DownHL
319+  8374 10 F4                        djnz    .shift7
320+  8376                              ;jr		.charDone
321+  8376
322+  8376              .charDone: 		; Получаем из стека начальный адрес на экране
323+  8376 E1           				pop		hl
324+  8377 4C           				ld		c, h				; сохраняем старший байт в C для проверки внизу
325+  8378              				; Расчитываем адрес в области атрибутов
326+  8378 7C                           ld      a, h
327+  8379 1F                  			rra
328+  837A 1F                           rra
329+  837B 1F                           rra
330+  837C E6 03                        and     0x03
331+  837E F6 58                        or      0x58
332+  8380 67                           ld      h, a
333+  8381                              ; Восстанавливаем A
334+  8381 08                           ex      af, af'
335+  8382                              ; Записываем атрибут
336+  8382 77                           ld      (hl), a
337+  8383                              ; Сохраняем атрибут в B
338+  8383 47                           ld		b, a
339+  8384                              ; Проверяем, нужно ли рисовать второй атрибут
340+  8384 3E 07                        ld		a, 7
341+  8386 A1                           and		c
342+  8387 C8                           ret		z				; мы на границе знакоместа, второй атрибут не нужен
343+  8388              				; Переходим на следующую строку в атрибутах
344+  8388 11 20 00                     ld		de, 32
345+  838B 19                           add		hl, de
346+  838C              				; Записываем второй атрибут
347+  838C 70                           ld		(hl), b
348+  838D C9                           ret
349+  838E
350+  838E                              ; Input:
351+  838E                              ;	HL => адрес байта (8 пикселей) на экране
352+  838E                              ; Output:
353+  838E                              ;   HL => адрес байта (8 пикселей) в следующей строке (Y = Y + 1)
354+  838E
355+  838E 24           DownHL:			inc		h
356+  838F 3E 07        				ld		a, 00000111b	; 7=8-1;  остаток от деления на 8
357+  8391 A4           				and		h
358+  8392 C0           				ret		nz
359+  8393 7D           				ld		a, l			; L = L + 32
360+  8394 D6 E0        				sub		-32
361+  8396 6F           				ld		l, a
362+  8397 9F           				sbc		a, a			; 0 = no carry, -1 (0xff 11111111) = was carry
363+  8398 E6 F8        				and		-8				; 0 = no carry, -8 (0xf8 11111000) = was carry
364+  839A 84           				add		a, h
365+  839B 67           				ld		h, a
366+  839C C9           				ret
367+  839D
# file closed: draw.asm
 43   839D              					include		"input.asm"
# file opened: input.asm
  1+  839D
  2+  839D 01 FE FB     ReadInput:			ld			bc, 0xfbfe
  3+  83A0 ED 78        					in			a, (c)
  4+  83A2 E6 01        					and			1					; Q
  5+  83A4 32 CF 83     					ld			(Input.up), a
  6+  83A7
  7+  83A7 01 FE FD     					ld			bc, 0xfdfe
  8+  83AA ED 78        					in			a, (c)
  9+  83AC E6 01        					and			1					; A
 10+  83AE 32 D0 83     					ld			(Input.down), a
 11+  83B1
 12+  83B1 01 FE DF     					ld			bc, 0xdffe
 13+  83B4 ED 78        					in			a, (c)
 14+  83B6 47           					ld			b, a
 15+  83B7 E6 02        					and			2					; O
 16+  83B9 32 CD 83     					ld			(Input.left), a
 17+  83BC
 18+  83BC 78           					ld			a, b
 19+  83BD E6 01        					and			1					; P
 20+  83BF 32 CE 83     					ld			(Input.right), a
 21+  83C2
 22+  83C2 01 FE 7F     					ld			bc, 0x7ffe
 23+  83C5 ED 78        					in			a, (c)
 24+  83C7 E6 01        					and			1					; Space
 25+  83C9 32 D1 83     					ld			(Input.fire), a
 26+  83CC
 27+  83CC C9           					ret
 28+  83CD
 29+  83CD              Input:
 30+  83CD 01           .left:				db			1
 31+  83CE 01           .right:				db			1
 32+  83CF 01           .up:				db			1
 33+  83D0 01           .down:				db			1
 34+  83D1 01           .fire:				db			1
 35+  83D2
# file closed: input.asm
 44   83D2              					include		"level.asm"
# file opened: level.asm
  1+  83D2
  2+  83D2              LEVEL_WIDTH 		equ		 	32
  3+  83D2              LEVEL_HEIGHT 		equ 		20
  4+  83D2
  5+  83D2              FLOOR_ATTR 			equ 		01001111b
  6+  83D2              SPHERE_ATTR 		equ 		01001110b
  7+  83D2              WALL_ATTR  			equ 		00001101b
  8+  83D2              TARGET_ATTR			equ			01001010b
  9+  83D2
 10+  83D2              					; пробел - пустое место
 11+  83D2              					; X - стена
 12+  83D2              					; 1 - точка старта
 13+  83D2
 14+  83D2 58 58 58 58  Level:				db			"XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"
 14+  83D6 58 58 58 58
 14+  83DA 58 58 58 58
 14+  83DE 58 58 58 58
 14+  83E2 58 58 58 58
 14+  83E6 58 58 58 58
 14+  83EA 58 58 58 58
 14+  83EE 58 58 58 58
 15+  83F2 58 20 20 20  					db			"X                              X"
 15+  83F6 20 20 20 20
 15+  83FA 20 20 20 20
 15+  83FE 20 20 20 20
 15+  8402 20 20 20 20
 15+  8406 20 20 20 20
 15+  840A 20 20 20 20
 15+  840E 20 20 20 58
 16+  8412 58 20 20 20  					db			"X                              X"
 16+  8416 20 20 20 20
 16+  841A 20 20 20 20
 16+  841E 20 20 20 20
 16+  8422 20 20 20 20
 16+  8426 20 20 20 20
 16+  842A 20 20 20 20
 16+  842E 20 20 20 58
 17+  8432 58 20 20 20  					db			"X                      O    *  X"
 17+  8436 20 20 20 20
 17+  843A 20 20 20 20
 17+  843E 20 20 20 20
 17+  8442 20 20 20 20
 17+  8446 20 20 20 4F
 17+  844A 20 20 20 20
 17+  844E 2A 20 20 58
 18+  8452 58 20 2A 20  					db			"X * O                          X"
 18+  8456 4F 20 20 20
 18+  845A 20 20 20 20
 18+  845E 20 20 20 20
 18+  8462 20 20 20 20
 18+  8466 20 20 20 20
 18+  846A 20 20 20 20
 18+  846E 20 20 20 58
 19+  8472 58 20 20 20  					db			"X                              X"
 19+  8476 20 20 20 20
 19+  847A 20 20 20 20
 19+  847E 20 20 20 20
 19+  8482 20 20 20 20
 19+  8486 20 20 20 20
 19+  848A 20 20 20 20
 19+  848E 20 20 20 58
 20+  8492 58 20 20 20  					db			"X        1                     X"
 20+  8496 20 20 20 20
 20+  849A 20 31 20 20
 20+  849E 20 20 20 20
 20+  84A2 20 20 20 20
 20+  84A6 20 20 20 20
 20+  84AA 20 20 20 20
 20+  84AE 20 20 20 58
 21+  84B2 58 20 20 20  					db			"X                              X"
 21+  84B6 20 20 20 20
 21+  84BA 20 20 20 20
 21+  84BE 20 20 20 20
 21+  84C2 20 20 20 20
 21+  84C6 20 20 20 20
 21+  84CA 20 20 20 20
 21+  84CE 20 20 20 58
 22+  84D2 58 20 20 20  					db			"X        *  O                  X"
 22+  84D6 20 20 20 20
 22+  84DA 20 2A 20 20
 22+  84DE 4F 20 20 20
 22+  84E2 20 20 20 20
 22+  84E6 20 20 20 20
 22+  84EA 20 20 20 20
 22+  84EE 20 20 20 58
 23+  84F2 58 20 20 20  					db			"X                        O  *  X"
 23+  84F6 20 20 20 20
 23+  84FA 20 20 20 20
 23+  84FE 20 20 20 20
 23+  8502 20 20 20 20
 23+  8506 20 20 20 20
 23+  850A 20 4F 20 20
 23+  850E 2A 20 20 58
 24+  8512 58 20 20 20  					db			"X           *  O               X"
 24+  8516 20 20 20 20
 24+  851A 20 20 20 20
 24+  851E 2A 20 20 4F
 24+  8522 20 20 20 20
 24+  8526 20 20 20 20
 24+  852A 20 20 20 20
 24+  852E 20 20 20 58
 25+  8532 58 20 20 20  					db			"X                              X"
 25+  8536 20 20 20 20
 25+  853A 20 20 20 20
 25+  853E 20 20 20 20
 25+  8542 20 20 20 20
 25+  8546 20 20 20 20
 25+  854A 20 20 20 20
 25+  854E 20 20 20 58
 26+  8552 58 20 20 20  					db			"X                              X"
 26+  8556 20 20 20 20
 26+  855A 20 20 20 20
 26+  855E 20 20 20 20
 26+  8562 20 20 20 20
 26+  8566 20 20 20 20
 26+  856A 20 20 20 20
 26+  856E 20 20 20 58
 27+  8572 58 20 58 58  					db			"X XXX XXX X X XXX XXX  X  XX X X"
 27+  8576 58 20 58 58
 27+  857A 58 20 58 20
 27+  857E 58 20 58 58
 27+  8582 58 20 58 58
 27+  8586 58 20 20 58
 27+  858A 20 20 58 58
 27+  858E 20 58 20 58
 28+  8592 58 20 58 20  					db			"X X   X X X X X X X X X X XX X X"
 28+  8596 20 20 58 20
 28+  859A 58 20 58 20
 28+  859E 58 20 58 20
 28+  85A2 58 20 58 20
 28+  85A6 58 20 58 20
 28+  85AA 58 20 58 58
 28+  85AE 20 58 20 58
 29+  85B2 58 20 58 58  					db			"X XXX X X XX  X X XX  XXX X XX X"
 29+  85B6 58 20 58 20
 29+  85BA 58 20 58 58
 29+  85BE 20 20 58 20
 29+  85C2 58 20 58 58
 29+  85C6 20 20 58 58
 29+  85CA 58 20 58 20
 29+  85CE 58 58 20 58
 30+  85D2 58 20 20 20  					db			"X   X X X X X X X X X X X X XX X"
 30+  85D6 58 20 58 20
 30+  85DA 58 20 58 20
 30+  85DE 58 20 58 20
 30+  85E2 58 20 58 20
 30+  85E6 58 20 58 20
 30+  85EA 58 20 58 20
 30+  85EE 58 58 20 58
 31+  85F2 58 20 58 58  					db			"X XXX XXX X X XXX XXX X X X  X X"
 31+  85F6 58 20 58 58
 31+  85FA 58 20 58 20
 31+  85FE 58 20 58 58
 31+  8602 58 20 58 58
 31+  8606 58 20 58 20
 31+  860A 58 20 58 20
 31+  860E 20 58 20 58
 32+  8612 58 20 20 20  					db			"X                              X"
 32+  8616 20 20 20 20
 32+  861A 20 20 20 20
 32+  861E 20 20 20 20
 32+  8622 20 20 20 20
 32+  8626 20 20 20 20
 32+  862A 20 20 20 20
 32+  862E 20 20 20 58
 33+  8632 58 58 58 58  					db			"XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"
 33+  8636 58 58 58 58
 33+  863A 58 58 58 58
 33+  863E 58 58 58 58
 33+  8642 58 58 58 58
 33+  8646 58 58 58 58
 33+  864A 58 58 58 58
 33+  864E 58 58 58 58
 34+  8652              LevelEnd:
 35+  8652
 36+  8652 21 52 86     InitLevel:			ld			hl, LevelEnd
 37+  8655 0E 14        					ld			c, LEVEL_HEIGHT
 38+  8657 06 20        .rowLoop:			ld			b, LEVEL_WIDTH
 39+  8659 2B           .colLoop:			dec			hl
 40+  865A 7E           					ld			a, (hl)
 41+  865B FE 31        					cp			a, '1'
 42+  865D CC 6B 86     					call		z, .handlePlayerStart
 43+  8660 FE 2A        					cp			a, '*'
 44+  8662 CC 78 86     					call		z, .handleTarget
 45+  8665 10 F2        					djnz		.colLoop
 46+  8667 0D           					dec			c
 47+  8668 20 ED        					jr			nz, .rowLoop
 48+  866A C9           					ret
 49+  866B 36 20        .handlePlayerStart:	ld			(hl), ' '
 50+  866D 78           					ld			a, b
 51+  866E 3D           					dec			a
 52+  866F 32 DD 86     					ld			(player1.x), a
 53+  8672 79           					ld			a, c
 54+  8673 3D           					dec			a
 55+  8674 32 DE 86     					ld			(player1.y), a
 56+  8677 C9           					ret
 57+  8678 36 20        .handleTarget:		ld			(hl), ' '
 58+  867A C9           					ret
 59+  867B
 60+  867B 21 52 86     DrawLevel:			ld			hl, LevelEnd
 61+  867E 06 14        					ld			b, LEVEL_HEIGHT
 62+  8680 0E 20        .rowLoop:			ld			c, LEVEL_WIDTH
 63+  8682 2B           .colLoop:			dec			hl
 64+  8683 7E           					ld			a, (hl)
 65+  8684 FE 20        					cp			a, ' '
 66+  8686 CC A5 86     					call		z, .drawFloor
 67+  8689 FE 58        					cp			a, 'X'
 68+  868B CC B3 86     					call		z, .drawWall
 69+  868E FE 4F        					cp			a, 'O'
 70+  8690 CC AC 86     					call		z, .drawSphere
 71+  8693 FE 2A        					cp			a, '*'
 72+  8695 CC 9E 86     					call		z, .drawTarget
 73+  8698 0D           					dec			c
 74+  8699 20 E7        					jr			nz, .colLoop
 75+  869B 10 E3        					djnz		.rowLoop
 76+  869D C9           					ret
 77+  869E 3E 4A        .drawTarget:		ld			a, TARGET_ATTR
 78+  86A0 11 02 02     					ld			de, 0x202
 79+  86A3 18 13        					jr			.drawChar
 80+  86A5 3E 4F        .drawFloor:			ld			a, FLOOR_ATTR
 81+  86A7 11 01 02     					ld			de, 0x201
 82+  86AA 18 0C        					jr			.drawChar
 83+  86AC 3E 4E        .drawSphere:		ld			a, SPHERE_ATTR
 84+  86AE 11 00 01     					ld			de, 0x100
 85+  86B1 18 05        					jr			.drawChar
 86+  86B3 3E 0D        .drawWall:			ld			a, WALL_ATTR
 87+  86B5 11 00 02     					ld			de, 0x200
 88+  86B8              					;jr			.drawChar
 89+  86B8 C5           .drawChar:			push		bc
 90+  86B9 E5           					push		hl
 91+  86BA 05           					dec			b
 92+  86BB 0D           					dec			c
 93+  86BC 21 00 00     					ld			hl, 0
 94+  86BF EB           					ex			de, hl
 95+  86C0 CD 4E 82     					call		DrawChar
 96+  86C3 E1           					pop			hl
 97+  86C4 C1           					pop			bc
 98+  86C5 C9           					ret
 99+  86C6
100+  86C6              					; Input:
101+  86C6              	                ;   C = X (знакоместо)
102+  86C6                  	            ;   B = Y (знакоместо)
103+  86C6                  	            ; Output:
104+  86C6                  	            ;	A = предмет на карте
105+  86C6                  	            ;   ZF=0 если ходить нельзя, ZF=1 если ходить можно
106+  86C6
107+  86C6 CD CD 86     CheckBlocked:		call		GetLevelAddr
108+  86C9 7E           					ld			a, (hl)
109+  86CA FE 20        					cp			a, ' '
110+  86CC C9           					ret
111+  86CD
112+  86CD              					; Input:
113+  86CD              	                ;   C = X (знакоместо)
114+  86CD                  	            ;   B = Y (знакоместо)
115+  86CD                  	            ; Output:
116+  86CD                  	            ;	HL => адрес внутри Level
117+  86CD
118+  86CD              GetLevelAddr:		; HL = B * 32 + C; 32 = LEVEL_WIDTH
119+  86CD 68           					ld			l, b
120+  86CE 26 00        					ld			h, 0
121+  86D0 59           					ld			e, c
122+  86D1 54           					ld			d, h
123+  86D2 29           					add			hl, hl			; *2
124+  86D3 29           					add			hl, hl			; *4
125+  86D4 29           					add			hl, hl			; *8
126+  86D5 29           					add			hl, hl			; *16
127+  86D6 29           					add			hl, hl			; *32
128+  86D7 19           					add			hl, de
129+  86D8 11 D2 83     					ld			de, Level
130+  86DB 19           					add			hl, de
131+  86DC C9           					ret
132+  86DD
# file closed: level.asm
 45   86DD              					include		"player.asm"
# file opened: player.asm
  1+  86DD
  2+  86DD              PLAYER_IDLE			equ			0
  3+  86DD              PLAYER_GO_LEFT		equ			3
  4+  86DD              PLAYER_GO_RIGHT		equ			6
  5+  86DD              PLAYER_GO_UP		equ			9
  6+  86DD              PLAYER_GO_DOWN		equ			12
  7+  86DD              PLAYER_SHIFT_LEFT	equ			15
  8+  86DD              PLAYER_SHIFT_RIGHT	equ			18
  9+  86DD              PLAYER_SHIFT_UP		equ			21
 10+  86DD              PLAYER_SHIFT_DOWN	equ			24
 11+  86DD
 12+  86DD              ;PLAYER_MAX_X		equ 		31
 13+  86DD              ;PLAYER_MAX_Y		equ			23
 14+  86DD
 15+  86DD              PLAYER_MOVE_DELAY_BITS equ		1
 16+  86DD
 17+  86DD              PLAYER_ATTR			equ			FLOOR_ATTR
 18+  86DD
 19+  86DD              					struct 		SPLAYER
 20+  86DD ~            x 					byte
 21+  86DD ~            y 					byte
 22+  86DD ~            state				byte
 23+  86DD ~            time				byte
 24+  86DD              					ends
 25+  86DD
 26+  86DD 05 02 00 00  player1:			SPLAYER		5,2,PLAYER_IDLE,0
 27+  86E1
 28+  86E1 DD 36 02 00  InitPlayer:			ld			(ix+SPLAYER.state), PLAYER_IDLE
 29+  86E5 C9           					ret
 30+  86E6
 31+  86E6              ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 32+  86E6
 33+  86E6              					macro		DRAWHORZ left, shift
 34+  86E6 ~
 35+  86E6 ~            					ld			a, (ix+SPLAYER.time)
 36+  86E6 ~            					dup			PLAYER_MOVE_DELAY_BITS
 37+  86E6 ~            					rrca
 38+  86E6 ~            					edup
 39+  86E6 ~            					and			(1<<(8-PLAYER_MOVE_DELAY_BITS))-1
 40+  86E6 ~            					inc			a
 41+  86E6 ~            				if left
 42+  86E6 ~            					neg
 43+  86E6 ~            				endif
 44+  86E6 ~            					ld			e, a
 45+  86E6 ~
 46+  86E6 ~            				if shift
 47+  86E6 ~            					and			3
 48+  86E6 ~            					ld			h, 0x01
 49+  86E6 ~            					ld			l, a
 50+  86E6 ~            					ld			d, 0
 51+  86E6 ~
 52+  86E6 ~            					push		af
 53+  86E6 ~
 54+  86E6 ~            					push		bc
 55+  86E6 ~            					push		de
 56+  86E6 ~            					push		hl
 57+  86E6 ~            					ld			a, SPHERE_ATTR
 58+  86E6 ~            					call		DrawChar
 59+  86E6 ~            					pop			hl
 60+  86E6 ~            					pop			de
 61+  86E6 ~            					pop			bc
 62+  86E6 ~
 63+  86E6 ~            					push		bc
 64+  86E6 ~            					push		de
 65+  86E6 ~            				if left
 66+  86E6 ~            					dec			c
 67+  86E6 ~            					ld			a, 8
 68+  86E6 ~            					add			a, e
 69+  86E6 ~            				else
 70+  86E6 ~            					inc			c
 71+  86E6 ~            					ld			a, e
 72+  86E6 ~            					sub			8
 73+  86E6 ~            				endif
 74+  86E6 ~            					ld			e, a
 75+  86E6 ~            					ld			a, SPHERE_ATTR
 76+  86E6 ~            					call		DrawChar
 77+  86E6 ~            					pop			de
 78+  86E6 ~            					pop			bc
 79+  86E6 ~
 80+  86E6 ~            					pop			af
 81+  86E6 ~            				endif ; shift
 82+  86E6 ~
 83+  86E6 ~            					rrca
 84+  86E6 ~            					and			1
 85+  86E6 ~            				if left
 86+  86E6 ~            					inc			a
 87+  86E6 ~            				else
 88+  86E6 ~            					add			a, 3
 89+  86E6 ~            				endif
 90+  86E6 ~            					ld			l, a
 91+  86E6 ~            					ld			h, 0
 92+  86E6 ~            					ld			d, h
 93+  86E6 ~
 94+  86E6 ~            					push		hl
 95+  86E6 ~            					push		de
 96+  86E6 ~            					push		bc
 97+  86E6 ~            					ld			a, PLAYER_ATTR
 98+  86E6 ~            				if left
 99+  86E6 ~            					inc			c
100+  86E6 ~            				else
101+  86E6 ~            					dec			c
102+  86E6 ~            				endif
103+  86E6 ~            					call		DrawChar
104+  86E6 ~            					pop			bc
105+  86E6 ~            					pop			de
106+  86E6 ~            					pop			hl
107+  86E6 ~
108+  86E6 ~            				if shift
109+  86E6 ~            					ld			a, DRAW_OR
110+  86E6 ~            					call		SetDrawCharMode
111+  86E6 ~            				endif
112+  86E6 ~
113+  86E6 ~            					ld			a, e
114+  86E6 ~            				if left
115+  86E6 ~            					add			a, 8
116+  86E6 ~            				else
117+  86E6 ~            					sub			8
118+  86E6 ~            				endif
119+  86E6 ~            					ld			e, a
120+  86E6 ~            					ld			a, PLAYER_ATTR
121+  86E6 ~            				if shift
122+  86E6 ~            					call		DrawChar
123+  86E6 ~            					ld			a, DRAW_REPLACE
124+  86E6 ~            					jp			SetDrawCharMode
125+  86E6 ~            				else
126+  86E6 ~            					jp			DrawChar
127+  86E6 ~            				endif
128+  86E6 ~
129+  86E6              					endm
130+  86E6
131+  86E6              ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
132+  86E6
133+  86E6              					macro		DRAWVERT up, shift
134+  86E6 ~
135+  86E6 ~            					ld			a, (ix+SPLAYER.time)
136+  86E6 ~            					dup			PLAYER_MOVE_DELAY_BITS
137+  86E6 ~            					rrca
138+  86E6 ~            					edup
139+  86E6 ~            					and			(1<<(8-PLAYER_MOVE_DELAY_BITS))-1
140+  86E6 ~            					inc			a
141+  86E6 ~            				if up
142+  86E6 ~            					neg
143+  86E6 ~            				endif
144+  86E6 ~            					ld			d, a
145+  86E6 ~            					ld			e, 0
146+  86E6 ~
147+  86E6 ~            					and			3
148+  86E6 ~
149+  86E6 ~            				if shift
150+  86E6 ~            					push		af
151+  86E6 ~            					push		de
152+  86E6 ~            					push		bc
153+  86E6 ~            					ld			h, 1
154+  86E6 ~            					ld			l, a
155+  86E6 ~            					ld			a, SPHERE_ATTR
156+  86E6 ~            					call		DrawChar
157+  86E6 ~            					pop			bc
158+  86E6 ~            					pop			de
159+  86E6 ~            					pop			af
160+  86E6 ~            			 	endif ; shift
161+  86E6 ~
162+  86E6 ~            					add			a, 5
163+  86E6 ~            					ld			l, a
164+  86E6 ~            					ld			h, e
165+  86E6 ~
166+  86E6 ~            					ld			a, PLAYER_ATTR
167+  86E6 ~            				if up
168+  86E6 ~            					inc			b
169+  86E6 ~            					push		de
170+  86E6 ~            					push		bc
171+  86E6 ~            					call		DrawChar
172+  86E6 ~            					pop			bc
173+  86E6 ~            					pop			de
174+  86E6 ~
175+  86E6 ~            					ld			a, 8
176+  86E6 ~            					add			a, d
177+  86E6 ~            					ld			d, a
178+  86E6 ~            					jp			DrawEmptyByte
179+  86E6 ~            				else
180+  86E6 ~            					dec			b
181+  86E6 ~            					jp			DrawChar
182+  86E6 ~            				endif
183+  86E6 ~
184+  86E6              					endm
185+  86E6
186+  86E6              ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
187+  86E6
188+  86E6 DD 4E 00     DrawPlayer:			ld			c, (ix+SPLAYER.x)
189+  86E9 DD 46 01     					ld			b, (ix+SPLAYER.y)
190+  86EC
191+  86EC DD 6E 02     					ld			l, (ix+SPLAYER.state)
192+  86EF 26 00        					ld			h, 0
193+  86F1 11 F6 86     					ld			de, .jumpTable
194+  86F4 19           					add			hl, de
195+  86F5 E9           					jp			(hl)
196+  86F6 C3 11 87     .jumpTable:			jp			.drawIdle
197+  86F9 C3 3B 88     					jp			.drawLeft
198+  86FC C3 15 88     					jp			.drawRight
199+  86FF C3 78 88     					jp			.drawUp
200+  8702 C3 62 88     					jp			.drawDown
201+  8705 C3 1B 87     					jp			.drawShiftLeft
202+  8708 C3 6E 87     					jp			.drawShiftRight
203+  870B C3 C0 87     					jp			.drawShiftUp
204+  870E C3 F1 87     					jp			.drawShiftDown
205+  8711
206+  8711 21 00 00     .drawIdle:			ld			hl, 0x0000
207+  8714 54           					ld			d, h
208+  8715 5C           					ld			e, h
209+  8716 3E 4F        					ld			a, PLAYER_ATTR
210+  8718 C3 4E 82     					jp			DrawChar
211+  871B
212+  871B              .drawShiftLeft:		DRAWHORZ 	1, 1
212+  871B             >
212+  871B DD 7E 03    >					ld			a, (ix+SPLAYER.time)
212+  871E             >					dup			PLAYER_MOVE_DELAY_BITS
212+  871E 0F          >					rrca
212+  871F             >					edup
212+  871F E6 7F       >					and			(1<<(8-PLAYER_MOVE_DELAY_BITS))-1
212+  8721 3C          >					inc			a
212+  8722             >				if 1
212+  8722 ED 44       >					neg
212+  8724             >				endif
212+  8724 5F          >					ld			e, a
212+  8725             >
212+  8725             >				if 1
212+  8725 E6 03       >					and			3
212+  8727 26 01       >					ld			h, 0x01
212+  8729 6F          >					ld			l, a
212+  872A 16 00       >					ld			d, 0
212+  872C             >
212+  872C F5          >					push		af
212+  872D             >
212+  872D C5          >					push		bc
212+  872E D5          >					push		de
212+  872F E5          >					push		hl
212+  8730 3E 4E       >					ld			a, SPHERE_ATTR
212+  8732 CD 4E 82    >					call		DrawChar
212+  8735 E1          >					pop			hl
212+  8736 D1          >					pop			de
212+  8737 C1          >					pop			bc
212+  8738             >
212+  8738 C5          >					push		bc
212+  8739 D5          >					push		de
212+  873A             >				if 1
212+  873A 0D          >					dec			c
212+  873B 3E 08       >					ld			a, 8
212+  873D 83          >					add			a, e
212+  873E             >				else
212+  873E ~           >					inc			c
212+  873E ~           >					ld			a, e
212+  873E ~           >					sub			8
212+  873E             >				endif
212+  873E 5F          >					ld			e, a
212+  873F 3E 4E       >					ld			a, SPHERE_ATTR
212+  8741 CD 4E 82    >					call		DrawChar
212+  8744 D1          >					pop			de
212+  8745 C1          >					pop			bc
212+  8746             >
212+  8746 F1          >					pop			af
212+  8747             >				endif ; shift
212+  8747             >
212+  8747 0F          >					rrca
212+  8748 E6 01       >					and			1
212+  874A             >				if 1
212+  874A 3C          >					inc			a
212+  874B             >				else
212+  874B ~           >					add			a, 3
212+  874B             >				endif
212+  874B 6F          >					ld			l, a
212+  874C 26 00       >					ld			h, 0
212+  874E 54          >					ld			d, h
212+  874F             >
212+  874F E5          >					push		hl
212+  8750 D5          >					push		de
212+  8751 C5          >					push		bc
212+  8752 3E 4F       >					ld			a, PLAYER_ATTR
212+  8754             >				if 1
212+  8754 0C          >					inc			c
212+  8755             >				else
212+  8755 ~           >					dec			c
212+  8755             >				endif
212+  8755 CD 4E 82    >					call		DrawChar
212+  8758 C1          >					pop			bc
212+  8759 D1          >					pop			de
212+  875A E1          >					pop			hl
212+  875B             >
212+  875B             >				if 1
212+  875B 3E B6       >					ld			a, DRAW_OR
212+  875D CD 1D 82    >					call		SetDrawCharMode
212+  8760             >				endif
212+  8760             >
212+  8760 7B          >					ld			a, e
212+  8761             >				if 1
212+  8761 C6 08       >					add			a, 8
212+  8763             >				else
212+  8763 ~           >					sub			8
212+  8763             >				endif
212+  8763 5F          >					ld			e, a
212+  8764 3E 4F       >					ld			a, PLAYER_ATTR
212+  8766             >				if 1
212+  8766 CD 4E 82    >					call		DrawChar
212+  8769 3E 00       >					ld			a, DRAW_REPLACE
212+  876B C3 1D 82    >					jp			SetDrawCharMode
212+  876E             >				else
212+  876E ~           >					jp			DrawChar
212+  876E             >				endif
212+  876E             >
213+  876E              .drawShiftRight:	DRAWHORZ 	0, 1
213+  876E             >
213+  876E DD 7E 03    >					ld			a, (ix+SPLAYER.time)
213+  8771             >					dup			PLAYER_MOVE_DELAY_BITS
213+  8771 0F          >					rrca
213+  8772             >					edup
213+  8772 E6 7F       >					and			(1<<(8-PLAYER_MOVE_DELAY_BITS))-1
213+  8774 3C          >					inc			a
213+  8775             >				if 0
213+  8775 ~           >					neg
213+  8775             >				endif
213+  8775 5F          >					ld			e, a
213+  8776             >
213+  8776             >				if 1
213+  8776 E6 03       >					and			3
213+  8778 26 01       >					ld			h, 0x01
213+  877A 6F          >					ld			l, a
213+  877B 16 00       >					ld			d, 0
213+  877D             >
213+  877D F5          >					push		af
213+  877E             >
213+  877E C5          >					push		bc
213+  877F D5          >					push		de
213+  8780 E5          >					push		hl
213+  8781 3E 4E       >					ld			a, SPHERE_ATTR
213+  8783 CD 4E 82    >					call		DrawChar
213+  8786 E1          >					pop			hl
213+  8787 D1          >					pop			de
213+  8788 C1          >					pop			bc
213+  8789             >
213+  8789 C5          >					push		bc
213+  878A D5          >					push		de
213+  878B             >				if 0
213+  878B ~           >					dec			c
213+  878B ~           >					ld			a, 8
213+  878B ~           >					add			a, e
213+  878B             >				else
213+  878B 0C          >					inc			c
213+  878C 7B          >					ld			a, e
213+  878D D6 08       >					sub			8
213+  878F             >				endif
213+  878F 5F          >					ld			e, a
213+  8790 3E 4E       >					ld			a, SPHERE_ATTR
213+  8792 CD 4E 82    >					call		DrawChar
213+  8795 D1          >					pop			de
213+  8796 C1          >					pop			bc
213+  8797             >
213+  8797 F1          >					pop			af
213+  8798             >				endif ; shift
213+  8798             >
213+  8798 0F          >					rrca
213+  8799 E6 01       >					and			1
213+  879B             >				if 0
213+  879B ~           >					inc			a
213+  879B             >				else
213+  879B C6 03       >					add			a, 3
213+  879D             >				endif
213+  879D 6F          >					ld			l, a
213+  879E 26 00       >					ld			h, 0
213+  87A0 54          >					ld			d, h
213+  87A1             >
213+  87A1 E5          >					push		hl
213+  87A2 D5          >					push		de
213+  87A3 C5          >					push		bc
213+  87A4 3E 4F       >					ld			a, PLAYER_ATTR
213+  87A6             >				if 0
213+  87A6 ~           >					inc			c
213+  87A6             >				else
213+  87A6 0D          >					dec			c
213+  87A7             >				endif
213+  87A7 CD 4E 82    >					call		DrawChar
213+  87AA C1          >					pop			bc
213+  87AB D1          >					pop			de
213+  87AC E1          >					pop			hl
213+  87AD             >
213+  87AD             >				if 1
213+  87AD 3E B6       >					ld			a, DRAW_OR
213+  87AF CD 1D 82    >					call		SetDrawCharMode
213+  87B2             >				endif
213+  87B2             >
213+  87B2 7B          >					ld			a, e
213+  87B3             >				if 0
213+  87B3 ~           >					add			a, 8
213+  87B3             >				else
213+  87B3 D6 08       >					sub			8
213+  87B5             >				endif
213+  87B5 5F          >					ld			e, a
213+  87B6 3E 4F       >					ld			a, PLAYER_ATTR
213+  87B8             >				if 1
213+  87B8 CD 4E 82    >					call		DrawChar
213+  87BB 3E 00       >					ld			a, DRAW_REPLACE
213+  87BD C3 1D 82    >					jp			SetDrawCharMode
213+  87C0             >				else
213+  87C0 ~           >					jp			DrawChar
213+  87C0             >				endif
213+  87C0             >
214+  87C0              .drawShiftUp:		DRAWVERT	1, 1
214+  87C0             >
214+  87C0 DD 7E 03    >					ld			a, (ix+SPLAYER.time)
214+  87C3             >					dup			PLAYER_MOVE_DELAY_BITS
214+  87C3 0F          >					rrca
214+  87C4             >					edup
214+  87C4 E6 7F       >					and			(1<<(8-PLAYER_MOVE_DELAY_BITS))-1
214+  87C6 3C          >					inc			a
214+  87C7             >				if 1
214+  87C7 ED 44       >					neg
214+  87C9             >				endif
214+  87C9 57          >					ld			d, a
214+  87CA 1E 00       >					ld			e, 0
214+  87CC             >
214+  87CC E6 03       >					and			3
214+  87CE             >
214+  87CE             >				if 1
214+  87CE F5          >					push		af
214+  87CF D5          >					push		de
214+  87D0 C5          >					push		bc
214+  87D1 26 01       >					ld			h, 1
214+  87D3 6F          >					ld			l, a
214+  87D4 3E 4E       >					ld			a, SPHERE_ATTR
214+  87D6 CD 4E 82    >					call		DrawChar
214+  87D9 C1          >					pop			bc
214+  87DA D1          >					pop			de
214+  87DB F1          >					pop			af
214+  87DC             >			 	endif ; shift
214+  87DC             >
214+  87DC C6 05       >					add			a, 5
214+  87DE 6F          >					ld			l, a
214+  87DF 63          >					ld			h, e
214+  87E0             >
214+  87E0 3E 4F       >					ld			a, PLAYER_ATTR
214+  87E2             >				if 1
214+  87E2 04          >					inc			b
214+  87E3 D5          >					push		de
214+  87E4 C5          >					push		bc
214+  87E5 CD 4E 82    >					call		DrawChar
214+  87E8 C1          >					pop			bc
214+  87E9 D1          >					pop			de
214+  87EA             >
214+  87EA 3E 08       >					ld			a, 8
214+  87EC 82          >					add			a, d
214+  87ED 57          >					ld			d, a
214+  87EE C3 0F 82    >					jp			DrawEmptyByte
214+  87F1             >				else
214+  87F1 ~           >					dec			b
214+  87F1 ~           >					jp			DrawChar
214+  87F1             >				endif
214+  87F1             >
215+  87F1              .drawShiftDown:		DRAWVERT	0, 1
215+  87F1             >
215+  87F1 DD 7E 03    >					ld			a, (ix+SPLAYER.time)
215+  87F4             >					dup			PLAYER_MOVE_DELAY_BITS
215+  87F4 0F          >					rrca
215+  87F5             >					edup
215+  87F5 E6 7F       >					and			(1<<(8-PLAYER_MOVE_DELAY_BITS))-1
215+  87F7 3C          >					inc			a
215+  87F8             >				if 0
215+  87F8 ~           >					neg
215+  87F8             >				endif
215+  87F8 57          >					ld			d, a
215+  87F9 1E 00       >					ld			e, 0
215+  87FB             >
215+  87FB E6 03       >					and			3
215+  87FD             >
215+  87FD             >				if 1
215+  87FD F5          >					push		af
215+  87FE D5          >					push		de
215+  87FF C5          >					push		bc
215+  8800 26 01       >					ld			h, 1
215+  8802 6F          >					ld			l, a
215+  8803 3E 4E       >					ld			a, SPHERE_ATTR
215+  8805 CD 4E 82    >					call		DrawChar
215+  8808 C1          >					pop			bc
215+  8809 D1          >					pop			de
215+  880A F1          >					pop			af
215+  880B             >			 	endif ; shift
215+  880B             >
215+  880B C6 05       >					add			a, 5
215+  880D 6F          >					ld			l, a
215+  880E 63          >					ld			h, e
215+  880F             >
215+  880F 3E 4F       >					ld			a, PLAYER_ATTR
215+  8811             >				if 0
215+  8811 ~           >					inc			b
215+  8811 ~           >					push		de
215+  8811 ~           >					push		bc
215+  8811 ~           >					call		DrawChar
215+  8811 ~           >					pop			bc
215+  8811 ~           >					pop			de
215+  8811 ~           >
215+  8811 ~           >					ld			a, 8
215+  8811 ~           >					add			a, d
215+  8811 ~           >					ld			d, a
215+  8811 ~           >					jp			DrawEmptyByte
215+  8811             >				else
215+  8811 05          >					dec			b
215+  8812 C3 4E 82    >					jp			DrawChar
215+  8815             >				endif
215+  8815             >
216+  8815
217+  8815              .drawRight:			DRAWHORZ	0, 0
217+  8815             >
217+  8815 DD 7E 03    >					ld			a, (ix+SPLAYER.time)
217+  8818             >					dup			PLAYER_MOVE_DELAY_BITS
217+  8818 0F          >					rrca
217+  8819             >					edup
217+  8819 E6 7F       >					and			(1<<(8-PLAYER_MOVE_DELAY_BITS))-1
217+  881B 3C          >					inc			a
217+  881C             >				if 0
217+  881C ~           >					neg
217+  881C             >				endif
217+  881C 5F          >					ld			e, a
217+  881D             >
217+  881D             >				if 0
217+  881D ~           >					and			3
217+  881D ~           >					ld			h, 0x01
217+  881D ~           >					ld			l, a
217+  881D ~           >					ld			d, 0
217+  881D ~           >
217+  881D ~           >					push		af
217+  881D ~           >
217+  881D ~           >					push		bc
217+  881D ~           >					push		de
217+  881D ~           >					push		hl
217+  881D ~           >					ld			a, SPHERE_ATTR
217+  881D ~           >					call		DrawChar
217+  881D ~           >					pop			hl
217+  881D ~           >					pop			de
217+  881D ~           >					pop			bc
217+  881D ~           >
217+  881D ~           >					push		bc
217+  881D ~           >					push		de
217+  881D ~           >				if left
217+  881D ~           >					dec			c
217+  881D ~           >					ld			a, 8
217+  881D ~           >					add			a, e
217+  881D ~           >				else
217+  881D ~           >					inc			c
217+  881D ~           >					ld			a, e
217+  881D ~           >					sub			8
217+  881D ~           >				endif
217+  881D ~           >					ld			e, a
217+  881D ~           >					ld			a, SPHERE_ATTR
217+  881D ~           >					call		DrawChar
217+  881D ~           >					pop			de
217+  881D ~           >					pop			bc
217+  881D ~           >
217+  881D ~           >					pop			af
217+  881D             >				endif ; shift
217+  881D             >
217+  881D 0F          >					rrca
217+  881E E6 01       >					and			1
217+  8820             >				if 0
217+  8820 ~           >					inc			a
217+  8820             >				else
217+  8820 C6 03       >					add			a, 3
217+  8822             >				endif
217+  8822 6F          >					ld			l, a
217+  8823 26 00       >					ld			h, 0
217+  8825 54          >					ld			d, h
217+  8826             >
217+  8826 E5          >					push		hl
217+  8827 D5          >					push		de
217+  8828 C5          >					push		bc
217+  8829 3E 4F       >					ld			a, PLAYER_ATTR
217+  882B             >				if 0
217+  882B ~           >					inc			c
217+  882B             >				else
217+  882B 0D          >					dec			c
217+  882C             >				endif
217+  882C CD 4E 82    >					call		DrawChar
217+  882F C1          >					pop			bc
217+  8830 D1          >					pop			de
217+  8831 E1          >					pop			hl
217+  8832             >
217+  8832             >				if 0
217+  8832 ~           >					ld			a, DRAW_OR
217+  8832 ~           >					call		SetDrawCharMode
217+  8832             >				endif
217+  8832             >
217+  8832 7B          >					ld			a, e
217+  8833             >				if 0
217+  8833 ~           >					add			a, 8
217+  8833             >				else
217+  8833 D6 08       >					sub			8
217+  8835             >				endif
217+  8835 5F          >					ld			e, a
217+  8836 3E 4F       >					ld			a, PLAYER_ATTR
217+  8838             >				if 0
217+  8838 ~           >					call		DrawChar
217+  8838 ~           >					ld			a, DRAW_REPLACE
217+  8838 ~           >					jp			SetDrawCharMode
217+  8838             >				else
217+  8838 C3 4E 82    >					jp			DrawChar
217+  883B             >				endif
217+  883B             >
218+  883B              .drawLeft:			DRAWHORZ	1, 0
218+  883B             >
218+  883B DD 7E 03    >					ld			a, (ix+SPLAYER.time)
218+  883E             >					dup			PLAYER_MOVE_DELAY_BITS
218+  883E 0F          >					rrca
218+  883F             >					edup
218+  883F E6 7F       >					and			(1<<(8-PLAYER_MOVE_DELAY_BITS))-1
218+  8841 3C          >					inc			a
218+  8842             >				if 1
218+  8842 ED 44       >					neg
218+  8844             >				endif
218+  8844 5F          >					ld			e, a
218+  8845             >
218+  8845             >				if 0
218+  8845 ~           >					and			3
218+  8845 ~           >					ld			h, 0x01
218+  8845 ~           >					ld			l, a
218+  8845 ~           >					ld			d, 0
218+  8845 ~           >
218+  8845 ~           >					push		af
218+  8845 ~           >
218+  8845 ~           >					push		bc
218+  8845 ~           >					push		de
218+  8845 ~           >					push		hl
218+  8845 ~           >					ld			a, SPHERE_ATTR
218+  8845 ~           >					call		DrawChar
218+  8845 ~           >					pop			hl
218+  8845 ~           >					pop			de
218+  8845 ~           >					pop			bc
218+  8845 ~           >
218+  8845 ~           >					push		bc
218+  8845 ~           >					push		de
218+  8845 ~           >				if left
218+  8845 ~           >					dec			c
218+  8845 ~           >					ld			a, 8
218+  8845 ~           >					add			a, e
218+  8845 ~           >				else
218+  8845 ~           >					inc			c
218+  8845 ~           >					ld			a, e
218+  8845 ~           >					sub			8
218+  8845 ~           >				endif
218+  8845 ~           >					ld			e, a
218+  8845 ~           >					ld			a, SPHERE_ATTR
218+  8845 ~           >					call		DrawChar
218+  8845 ~           >					pop			de
218+  8845 ~           >					pop			bc
218+  8845 ~           >
218+  8845 ~           >					pop			af
218+  8845             >				endif ; shift
218+  8845             >
218+  8845 0F          >					rrca
218+  8846 E6 01       >					and			1
218+  8848             >				if 1
218+  8848 3C          >					inc			a
218+  8849             >				else
218+  8849 ~           >					add			a, 3
218+  8849             >				endif
218+  8849 6F          >					ld			l, a
218+  884A 26 00       >					ld			h, 0
218+  884C 54          >					ld			d, h
218+  884D             >
218+  884D E5          >					push		hl
218+  884E D5          >					push		de
218+  884F C5          >					push		bc
218+  8850 3E 4F       >					ld			a, PLAYER_ATTR
218+  8852             >				if 1
218+  8852 0C          >					inc			c
218+  8853             >				else
218+  8853 ~           >					dec			c
218+  8853             >				endif
218+  8853 CD 4E 82    >					call		DrawChar
218+  8856 C1          >					pop			bc
218+  8857 D1          >					pop			de
218+  8858 E1          >					pop			hl
218+  8859             >
218+  8859             >				if 0
218+  8859 ~           >					ld			a, DRAW_OR
218+  8859 ~           >					call		SetDrawCharMode
218+  8859             >				endif
218+  8859             >
218+  8859 7B          >					ld			a, e
218+  885A             >				if 1
218+  885A C6 08       >					add			a, 8
218+  885C             >				else
218+  885C ~           >					sub			8
218+  885C             >				endif
218+  885C 5F          >					ld			e, a
218+  885D 3E 4F       >					ld			a, PLAYER_ATTR
218+  885F             >				if 0
218+  885F ~           >					call		DrawChar
218+  885F ~           >					ld			a, DRAW_REPLACE
218+  885F ~           >					jp			SetDrawCharMode
218+  885F             >				else
218+  885F C3 4E 82    >					jp			DrawChar
218+  8862             >				endif
218+  8862             >
219+  8862              .drawDown:			DRAWVERT	0, 0
219+  8862             >
219+  8862 DD 7E 03    >					ld			a, (ix+SPLAYER.time)
219+  8865             >					dup			PLAYER_MOVE_DELAY_BITS
219+  8865 0F          >					rrca
219+  8866             >					edup
219+  8866 E6 7F       >					and			(1<<(8-PLAYER_MOVE_DELAY_BITS))-1
219+  8868 3C          >					inc			a
219+  8869             >				if 0
219+  8869 ~           >					neg
219+  8869             >				endif
219+  8869 57          >					ld			d, a
219+  886A 1E 00       >					ld			e, 0
219+  886C             >
219+  886C E6 03       >					and			3
219+  886E             >
219+  886E             >				if 0
219+  886E ~           >					push		af
219+  886E ~           >					push		de
219+  886E ~           >					push		bc
219+  886E ~           >					ld			h, 1
219+  886E ~           >					ld			l, a
219+  886E ~           >					ld			a, SPHERE_ATTR
219+  886E ~           >					call		DrawChar
219+  886E ~           >					pop			bc
219+  886E ~           >					pop			de
219+  886E ~           >					pop			af
219+  886E             >			 	endif ; shift
219+  886E             >
219+  886E C6 05       >					add			a, 5
219+  8870 6F          >					ld			l, a
219+  8871 63          >					ld			h, e
219+  8872             >
219+  8872 3E 4F       >					ld			a, PLAYER_ATTR
219+  8874             >				if 0
219+  8874 ~           >					inc			b
219+  8874 ~           >					push		de
219+  8874 ~           >					push		bc
219+  8874 ~           >					call		DrawChar
219+  8874 ~           >					pop			bc
219+  8874 ~           >					pop			de
219+  8874 ~           >
219+  8874 ~           >					ld			a, 8
219+  8874 ~           >					add			a, d
219+  8874 ~           >					ld			d, a
219+  8874 ~           >					jp			DrawEmptyByte
219+  8874             >				else
219+  8874 05          >					dec			b
219+  8875 C3 4E 82    >					jp			DrawChar
219+  8878             >				endif
219+  8878             >
220+  8878              .drawUp:			DRAWVERT	1, 0
220+  8878             >
220+  8878 DD 7E 03    >					ld			a, (ix+SPLAYER.time)
220+  887B             >					dup			PLAYER_MOVE_DELAY_BITS
220+  887B 0F          >					rrca
220+  887C             >					edup
220+  887C E6 7F       >					and			(1<<(8-PLAYER_MOVE_DELAY_BITS))-1
220+  887E 3C          >					inc			a
220+  887F             >				if 1
220+  887F ED 44       >					neg
220+  8881             >				endif
220+  8881 57          >					ld			d, a
220+  8882 1E 00       >					ld			e, 0
220+  8884             >
220+  8884 E6 03       >					and			3
220+  8886             >
220+  8886             >				if 0
220+  8886 ~           >					push		af
220+  8886 ~           >					push		de
220+  8886 ~           >					push		bc
220+  8886 ~           >					ld			h, 1
220+  8886 ~           >					ld			l, a
220+  8886 ~           >					ld			a, SPHERE_ATTR
220+  8886 ~           >					call		DrawChar
220+  8886 ~           >					pop			bc
220+  8886 ~           >					pop			de
220+  8886 ~           >					pop			af
220+  8886             >			 	endif ; shift
220+  8886             >
220+  8886 C6 05       >					add			a, 5
220+  8888 6F          >					ld			l, a
220+  8889 63          >					ld			h, e
220+  888A             >
220+  888A 3E 4F       >					ld			a, PLAYER_ATTR
220+  888C             >				if 1
220+  888C 04          >					inc			b
220+  888D D5          >					push		de
220+  888E C5          >					push		bc
220+  888F CD 4E 82    >					call		DrawChar
220+  8892 C1          >					pop			bc
220+  8893 D1          >					pop			de
220+  8894             >
220+  8894 3E 08       >					ld			a, 8
220+  8896 82          >					add			a, d
220+  8897 57          >					ld			d, a
220+  8898 C3 0F 82    >					jp			DrawEmptyByte
220+  889B             >				else
220+  889B ~           >					dec			b
220+  889B ~           >					jp			DrawChar
220+  889B             >				endif
220+  889B             >
221+  889B
222+  889B              ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
223+  889B
224+  889B              					macro 		PLAYERGO state, shift
225+  889B ~
226+  889B ~            					ld			c, (ix+SPLAYER.x)
227+  889B ~            					ld			b, (ix+SPLAYER.y)
228+  889B ~            				if state == PLAYER_GO_UP
229+  889B ~            					dec			b
230+  889B ~            				elseif state == PLAYER_GO_DOWN
231+  889B ~            					inc			b
232+  889B ~            				elseif state == PLAYER_GO_LEFT
233+  889B ~            					dec			c
234+  889B ~            				elseif state == PLAYER_GO_RIGHT
235+  889B ~            					inc			c
236+  889B ~            				endif
237+  889B ~            					call		CheckBlocked
238+  889B ~            					jr			nz, .tryShift
239+  889B ~            					ld			a, state
240+  889B ~            .doGo:			if state == PLAYER_GO_DOWN || state == PLAYER_GO_UP
241+  889B ~            					ld			(ix+SPLAYER.y), b
242+  889B ~            				elseif state == PLAYER_GO_LEFT || state == PLAYER_GO_RIGHT
243+  889B ~            					ld			(ix+SPLAYER.x), c
244+  889B ~            				endif
245+  889B ~            					ld			(ix+SPLAYER.state), a
246+  889B ~            					ld			(ix+SPLAYER.time), 0
247+  889B ~            					ret
248+  889B ~            .tryShift:			cp			'O'
249+  889B ~            					ret			nz
250+  889B ~            				if state == PLAYER_GO_UP
251+  889B ~            					dec			b
252+  889B ~            				elseif state == PLAYER_GO_DOWN
253+  889B ~            					inc			b
254+  889B ~            				elseif state == PLAYER_GO_LEFT
255+  889B ~            					dec			c
256+  889B ~            				elseif state == PLAYER_GO_RIGHT
257+  889B ~            					inc			c
258+  889B ~            				endif
259+  889B ~            					call		CheckBlocked
260+  889B ~            					ret			nz
261+  889B ~            					ld			(hl), 'O'
262+  889B ~            				if state == PLAYER_GO_UP
263+  889B ~            					inc			b
264+  889B ~            					ld			de, 32
265+  889B ~            					add			hl, de
266+  889B ~            				elseif state == PLAYER_GO_DOWN
267+  889B ~            					dec			b
268+  889B ~            					ld			de, -32
269+  889B ~            					add			hl, de
270+  889B ~            				elseif state == PLAYER_GO_LEFT
271+  889B ~            					inc			c
272+  889B ~            					inc			hl
273+  889B ~            				elseif state == PLAYER_GO_RIGHT
274+  889B ~            					dec			c
275+  889B ~            					dec			hl
276+  889B ~            				endif
277+  889B ~            					ld			(hl), ' '
278+  889B ~            					ld			a, shift
279+  889B ~            					jr			.doGo
280+  889B ~
281+  889B              					endm
282+  889B
283+  889B DD 6E 02     HandlePlayer:		ld			l, (ix+SPLAYER.state)
284+  889E 26 00        					ld			h, 0
285+  88A0 01 A5 88     					ld			bc, .jumpTable
286+  88A3 09           					add			hl, bc
287+  88A4 E9           					jp			(hl)
288+  88A5 C3 D4 88     .jumpTable:			jp			.idle
289+  88A8 C3 C0 88     					jp			.move
290+  88AB C3 C0 88     					jp			.move
291+  88AE C3 C0 88     					jp			.move
292+  88B1 C3 C0 88     					jp			.move
293+  88B4 C3 C0 88     					jp			.move
294+  88B7 C3 C0 88     					jp			.move
295+  88BA C3 C0 88     					jp			.move
296+  88BD C3 C0 88     					jp			.move
297+  88C0
298+  88C0 DD 7E 03     .move:				ld			a, (ix+SPLAYER.time)
299+  88C3 3C           					inc			a
300+  88C4 FE 10        					cp			(8<<PLAYER_MOVE_DELAY_BITS)
301+  88C6 28 04        					jr			z, .moveDone
302+  88C8 DD 77 03     					ld			(ix+SPLAYER.time), a
303+  88CB C9           					ret
304+  88CC DD 36 02 00  .moveDone:			ld			(ix+SPLAYER.state), PLAYER_IDLE
305+  88D0 DD 36 03 00  					ld			(ix+SPLAYER.time), 0
306+  88D4              					;jr			.idle
307+  88D4
308+  88D4 21 CD 83     .idle:				ld			hl, Input.left
309+  88D7 AF           					xor			a
310+  88D8 BE           					cp			(hl)
311+  88D9 28 0E        					jr			z, .goLeft
312+  88DB
313+  88DB 23           					inc			hl
314+  88DC BE           					cp			(hl)
315+  88DD 28 35        					jr			z, .goRight
316+  88DF
317+  88DF 23           					inc			hl
318+  88E0 BE           					cp			(hl)
319+  88E1 28 5C        					jr			z, .goUp
320+  88E3
321+  88E3 23           					inc			hl
322+  88E4 BE           					cp			(hl)
323+  88E5 CA 6D 89     					jp			z, .goDown
324+  88E8
325+  88E8 C9           					ret
326+  88E9
327+  88E9              .goLeft:			PLAYERGO	PLAYER_GO_LEFT, PLAYER_SHIFT_LEFT
327+  88E9             >
327+  88E9 DD 4E 00    >					ld			c, (ix+SPLAYER.x)
327+  88EC DD 46 01    >					ld			b, (ix+SPLAYER.y)
327+  88EF             >				if PLAYER_GO_LEFT == PLAYER_GO_UP
327+  88EF ~           >					dec			b
327+  88EF             >				elseif state == PLAYER_GO_DOWN
327+  88EF ~           >					inc			b
327+  88EF             >				elseif state == PLAYER_GO_LEFT
327+  88EF 0D          >					dec			c
327+  88F0             >				elseif state == PLAYER_GO_RIGHT
327+  88F0 ~           >					inc			c
327+  88F0             >				endif
327+  88F0 CD C6 86    >					call		CheckBlocked
327+  88F3 20 0D       >					jr			nz, .tryShift
327+  88F5 3E 03       >					ld			a, PLAYER_GO_LEFT
327+  88F7             >.doGo:			if PLAYER_GO_LEFT == PLAYER_GO_DOWN || PLAYER_GO_LEFT == PLAYER_GO_UP
327+  88F7 ~           >					ld			(ix+SPLAYER.y), b
327+  88F7             >				elseif state == PLAYER_GO_LEFT || state == PLAYER_GO_RIGHT
327+  88F7 DD 71 00    >					ld			(ix+SPLAYER.x), c
327+  88FA             >				endif
327+  88FA DD 77 02    >					ld			(ix+SPLAYER.state), a
327+  88FD DD 36 03 00 >					ld			(ix+SPLAYER.time), 0
327+  8901 C9          >					ret
327+  8902 FE 4F       >.tryShift:			cp			'O'
327+  8904 C0          >					ret			nz
327+  8905             >				if PLAYER_GO_LEFT == PLAYER_GO_UP
327+  8905 ~           >					dec			b
327+  8905             >				elseif state == PLAYER_GO_DOWN
327+  8905 ~           >					inc			b
327+  8905             >				elseif state == PLAYER_GO_LEFT
327+  8905 0D          >					dec			c
327+  8906             >				elseif state == PLAYER_GO_RIGHT
327+  8906 ~           >					inc			c
327+  8906             >				endif
327+  8906 CD C6 86    >					call		CheckBlocked
327+  8909 C0          >					ret			nz
327+  890A 36 4F       >					ld			(hl), 'O'
327+  890C             >				if PLAYER_GO_LEFT == PLAYER_GO_UP
327+  890C ~           >					inc			b
327+  890C ~           >					ld			de, 32
327+  890C ~           >					add			hl, de
327+  890C             >				elseif state == PLAYER_GO_DOWN
327+  890C ~           >					dec			b
327+  890C ~           >					ld			de, -32
327+  890C ~           >					add			hl, de
327+  890C             >				elseif state == PLAYER_GO_LEFT
327+  890C 0C          >					inc			c
327+  890D 23          >					inc			hl
327+  890E             >				elseif state == PLAYER_GO_RIGHT
327+  890E ~           >					dec			c
327+  890E ~           >					dec			hl
327+  890E             >				endif
327+  890E 36 20       >					ld			(hl), ' '
327+  8910 3E 0F       >					ld			a, PLAYER_SHIFT_LEFT
327+  8912 18 E3       >					jr			.doGo
327+  8914             >
328+  8914              .goRight:			PLAYERGO	PLAYER_GO_RIGHT, PLAYER_SHIFT_RIGHT
328+  8914             >
328+  8914 DD 4E 00    >					ld			c, (ix+SPLAYER.x)
328+  8917 DD 46 01    >					ld			b, (ix+SPLAYER.y)
328+  891A             >				if PLAYER_GO_RIGHT == PLAYER_GO_UP
328+  891A ~           >					dec			b
328+  891A             >				elseif state == PLAYER_GO_DOWN
328+  891A ~           >					inc			b
328+  891A             >				elseif state == PLAYER_GO_LEFT
328+  891A ~           >					dec			c
328+  891A             >				elseif state == PLAYER_GO_RIGHT
328+  891A 0C          >					inc			c
328+  891B             >				endif
328+  891B CD C6 86    >					call		CheckBlocked
328+  891E 20 0D       >					jr			nz, .tryShift
328+  8920 3E 06       >					ld			a, PLAYER_GO_RIGHT
328+  8922             >.doGo:			if PLAYER_GO_RIGHT == PLAYER_GO_DOWN || PLAYER_GO_RIGHT == PLAYER_GO_UP
328+  8922 ~           >					ld			(ix+SPLAYER.y), b
328+  8922             >				elseif state == PLAYER_GO_LEFT || state == PLAYER_GO_RIGHT
328+  8922 DD 71 00    >					ld			(ix+SPLAYER.x), c
328+  8925             >				endif
328+  8925 DD 77 02    >					ld			(ix+SPLAYER.state), a
328+  8928 DD 36 03 00 >					ld			(ix+SPLAYER.time), 0
328+  892C C9          >					ret
328+  892D FE 4F       >.tryShift:			cp			'O'
328+  892F C0          >					ret			nz
328+  8930             >				if PLAYER_GO_RIGHT == PLAYER_GO_UP
328+  8930 ~           >					dec			b
328+  8930             >				elseif state == PLAYER_GO_DOWN
328+  8930 ~           >					inc			b
328+  8930             >				elseif state == PLAYER_GO_LEFT
328+  8930 ~           >					dec			c
328+  8930             >				elseif state == PLAYER_GO_RIGHT
328+  8930 0C          >					inc			c
328+  8931             >				endif
328+  8931 CD C6 86    >					call		CheckBlocked
328+  8934 C0          >					ret			nz
328+  8935 36 4F       >					ld			(hl), 'O'
328+  8937             >				if PLAYER_GO_RIGHT == PLAYER_GO_UP
328+  8937 ~           >					inc			b
328+  8937 ~           >					ld			de, 32
328+  8937 ~           >					add			hl, de
328+  8937             >				elseif state == PLAYER_GO_DOWN
328+  8937 ~           >					dec			b
328+  8937 ~           >					ld			de, -32
328+  8937 ~           >					add			hl, de
328+  8937             >				elseif state == PLAYER_GO_LEFT
328+  8937 ~           >					inc			c
328+  8937 ~           >					inc			hl
328+  8937             >				elseif state == PLAYER_GO_RIGHT
328+  8937 0D          >					dec			c
328+  8938 2B          >					dec			hl
328+  8939             >				endif
328+  8939 36 20       >					ld			(hl), ' '
328+  893B 3E 12       >					ld			a, PLAYER_SHIFT_RIGHT
328+  893D 18 E3       >					jr			.doGo
328+  893F             >
329+  893F              .goUp:				PLAYERGO	PLAYER_GO_UP, PLAYER_SHIFT_UP
329+  893F             >
329+  893F DD 4E 00    >					ld			c, (ix+SPLAYER.x)
329+  8942 DD 46 01    >					ld			b, (ix+SPLAYER.y)
329+  8945             >				if PLAYER_GO_UP == PLAYER_GO_UP
329+  8945 05          >					dec			b
329+  8946             >				elseif state == PLAYER_GO_DOWN
329+  8946 ~           >					inc			b
329+  8946             >				elseif state == PLAYER_GO_LEFT
329+  8946 ~           >					dec			c
329+  8946             >				elseif state == PLAYER_GO_RIGHT
329+  8946 ~           >					inc			c
329+  8946             >				endif
329+  8946 CD C6 86    >					call		CheckBlocked
329+  8949 20 0D       >					jr			nz, .tryShift
329+  894B 3E 09       >					ld			a, PLAYER_GO_UP
329+  894D             >.doGo:			if PLAYER_GO_UP == PLAYER_GO_DOWN || PLAYER_GO_UP == PLAYER_GO_UP
329+  894D DD 70 01    >					ld			(ix+SPLAYER.y), b
329+  8950             >				elseif state == PLAYER_GO_LEFT || state == PLAYER_GO_RIGHT
329+  8950 ~           >					ld			(ix+SPLAYER.x), c
329+  8950             >				endif
329+  8950 DD 77 02    >					ld			(ix+SPLAYER.state), a
329+  8953 DD 36 03 00 >					ld			(ix+SPLAYER.time), 0
329+  8957 C9          >					ret
329+  8958 FE 4F       >.tryShift:			cp			'O'
329+  895A C0          >					ret			nz
329+  895B             >				if PLAYER_GO_UP == PLAYER_GO_UP
329+  895B 05          >					dec			b
329+  895C             >				elseif state == PLAYER_GO_DOWN
329+  895C ~           >					inc			b
329+  895C             >				elseif state == PLAYER_GO_LEFT
329+  895C ~           >					dec			c
329+  895C             >				elseif state == PLAYER_GO_RIGHT
329+  895C ~           >					inc			c
329+  895C             >				endif
329+  895C CD C6 86    >					call		CheckBlocked
329+  895F C0          >					ret			nz
329+  8960 36 4F       >					ld			(hl), 'O'
329+  8962             >				if PLAYER_GO_UP == PLAYER_GO_UP
329+  8962 04          >					inc			b
329+  8963 11 20 00    >					ld			de, 32
329+  8966 19          >					add			hl, de
329+  8967             >				elseif state == PLAYER_GO_DOWN
329+  8967 ~           >					dec			b
329+  8967 ~           >					ld			de, -32
329+  8967 ~           >					add			hl, de
329+  8967             >				elseif state == PLAYER_GO_LEFT
329+  8967 ~           >					inc			c
329+  8967 ~           >					inc			hl
329+  8967             >				elseif state == PLAYER_GO_RIGHT
329+  8967 ~           >					dec			c
329+  8967 ~           >					dec			hl
329+  8967             >				endif
329+  8967 36 20       >					ld			(hl), ' '
329+  8969 3E 15       >					ld			a, PLAYER_SHIFT_UP
329+  896B 18 E0       >					jr			.doGo
329+  896D             >
330+  896D              .goDown:			PLAYERGO	PLAYER_GO_DOWN, PLAYER_SHIFT_DOWN
330+  896D             >
330+  896D DD 4E 00    >					ld			c, (ix+SPLAYER.x)
330+  8970 DD 46 01    >					ld			b, (ix+SPLAYER.y)
330+  8973             >				if PLAYER_GO_DOWN == PLAYER_GO_UP
330+  8973 ~           >					dec			b
330+  8973             >				elseif state == PLAYER_GO_DOWN
330+  8973 04          >					inc			b
330+  8974             >				elseif state == PLAYER_GO_LEFT
330+  8974 ~           >					dec			c
330+  8974             >				elseif state == PLAYER_GO_RIGHT
330+  8974 ~           >					inc			c
330+  8974             >				endif
330+  8974 CD C6 86    >					call		CheckBlocked
330+  8977 20 0D       >					jr			nz, .tryShift
330+  8979 3E 0C       >					ld			a, PLAYER_GO_DOWN
330+  897B             >.doGo:			if PLAYER_GO_DOWN == PLAYER_GO_DOWN || PLAYER_GO_DOWN == PLAYER_GO_UP
330+  897B DD 70 01    >					ld			(ix+SPLAYER.y), b
330+  897E             >				elseif state == PLAYER_GO_LEFT || state == PLAYER_GO_RIGHT
330+  897E ~           >					ld			(ix+SPLAYER.x), c
330+  897E             >				endif
330+  897E DD 77 02    >					ld			(ix+SPLAYER.state), a
330+  8981 DD 36 03 00 >					ld			(ix+SPLAYER.time), 0
330+  8985 C9          >					ret
330+  8986 FE 4F       >.tryShift:			cp			'O'
330+  8988 C0          >					ret			nz
330+  8989             >				if PLAYER_GO_DOWN == PLAYER_GO_UP
330+  8989 ~           >					dec			b
330+  8989             >				elseif state == PLAYER_GO_DOWN
330+  8989 04          >					inc			b
330+  898A             >				elseif state == PLAYER_GO_LEFT
330+  898A ~           >					dec			c
330+  898A             >				elseif state == PLAYER_GO_RIGHT
330+  898A ~           >					inc			c
330+  898A             >				endif
330+  898A CD C6 86    >					call		CheckBlocked
330+  898D C0          >					ret			nz
330+  898E 36 4F       >					ld			(hl), 'O'
330+  8990             >				if PLAYER_GO_DOWN == PLAYER_GO_UP
330+  8990 ~           >					inc			b
330+  8990 ~           >					ld			de, 32
330+  8990 ~           >					add			hl, de
330+  8990             >				elseif state == PLAYER_GO_DOWN
330+  8990 05          >					dec			b
330+  8991 11 E0 FF    >					ld			de, -32
330+  8994 19          >					add			hl, de
330+  8995             >				elseif state == PLAYER_GO_LEFT
330+  8995 ~           >					inc			c
330+  8995 ~           >					inc			hl
330+  8995             >				elseif state == PLAYER_GO_RIGHT
330+  8995 ~           >					dec			c
330+  8995 ~           >					dec			hl
330+  8995             >				endif
330+  8995 36 20       >					ld			(hl), ' '
330+  8997 3E 18       >					ld			a, PLAYER_SHIFT_DOWN
330+  8999 18 E0       >					jr			.doGo
330+  899B             >
331+  899B
# file closed: player.asm
 46   899B
 47   899B 00 00 00...  					ds			0xa000-$
 48   A000              					org			0xa000
 49   A000
 50   A000              gfx:				incbin		"gfx/gfx.scr"
 51   BB00
 52   BB00              					savesna 	"game.sna", start
 53   BB00              					SLDOPT 		COMMENT WPMEM, LOGPOINT, ASSERTION
 54   BB00
# file closed: game.asm
